# Rundeck Node Filters Design

This document describes the design for generating predefined node filter presets in Rundeck jobs.

## Background

### Rundeck Saved Filters

Rundeck supports saved node filters that can be reused across jobs and commands:

- **How to save**: In the Nodes page, enter a filter query, click the down arrow, and name it
- **Reuse**: Saved filters appear in the Filters menu throughout Rundeck (Nodes page, job creation, ad-hoc commands)

**Limitations:**
- **User-scoped**: Saved filters are tied to user profiles, not project-wide
- **Database storage**: Filters are stored in the database (`node_filter` table), not in project config files
- **No API management**: No programmatic way to manage saved filters
- **Cross-project visibility issue**: Known bug where saved filters from one project may appear in others

### Node Attributes Available for Filtering

Each Rundeck node generated by the node source has these attributes:

| Attribute | Description |
|-----------|-------------|
| `targetType` | Workload type: `helm-release`, `statefulset`, or `deployment` |
| `targetValue` | Workload/release name |
| `targetNamespace` | Kubernetes namespace |
| `healthy` | Health status (`true`/`false`) |
| `healthyPods` | Count of running/ready pods |
| `podCount` | Total pod count |
| `cluster` | Cluster identifier (multi-cluster setups) |
| `clusterUrl` | Kubernetes API server URL |
| `workloadKind` | StatefulSet or Deployment |
| `workloadName` | Name of the underlying workload |

## How Node Filters Work with Jobs

### Job Node Filter Structure

```yaml
nodeFilterEditable: true    # Allow users to change filter at runtime
nodefilters:
  dispatch:
    threadcount: '1'        # Run on 1 node at a time
    keepgoing: 'false'      # Stop on first failure
    rankOrder: ascending    # Order of node execution
  filter: '.*'              # The node filter expression
```

### Execution Flow

1. At job execution time, Rundeck evaluates the `filter` against all nodes from the node source
2. Matching nodes become execution targets
3. The script runs once per matched node (with `nodeStep: true`)
4. Node attributes are available via `@node.attributeName@` syntax in scripts

### Example Script Using Node Attributes

```bash
_NODE_TYPE="@node.targetType@"
_NODE_VALUE="@node.targetValue@"
case "$_NODE_TYPE" in
  helm-release) cmd="$cmd --target-helm-release=\"$_NODE_VALUE\"" ;;
  statefulset)  cmd="$cmd --target-statefulset=\"$_NODE_VALUE\"" ;;
  deployment)   cmd="$cmd --target-deployment=\"$_NODE_VALUE\"" ;;
esac
```

## Design: Generated Filter Presets

Since Rundeck doesn't support project-level filter definitions, we use **job options with preset values**.

### Architecture

```
┌─────────────────────────────────────┐
│  Standard Filters (auto-generated)  │
│  - Based on node attribute schema   │
└──────────────┬──────────────────────┘
               │
               ▼
        ┌──────────────┐
        │    Merge     │
        └──────┬───────┘
               │
┌──────────────┴──────────────────────┐
│  Custom Filters (operator.yaml)     │
│  - User-defined for their env       │
└──────────────┬──────────────────────┘
               │
               ▼
┌─────────────────────────────────────┐
│  Generated Job Options              │
│  nodefilters:                       │
│    filter: '${option.node_filter}'  │
└─────────────────────────────────────┘
```

### Input File Format

Extend the existing `operator.yaml` config with a `nodeFilters` section:

```yaml
# operator.yaml
apiVersion: openapi-operator-gen/v1
kind: OperatorConfig
metadata:
  name: petstore-operator

spec:
  # ... existing config ...

  rundeck:
    # Custom node filters to add to generated jobs
    nodeFilters:
      # Simple filters
      - name: production
        filter: "targetNamespace: prod.*"
        description: "Production namespace workloads"

      - name: staging
        filter: "targetNamespace: staging.*"
        description: "Staging environment"

      # Combined filters
      - name: prod-healthy
        filter: "targetNamespace: prod.* healthy: true"
        description: "Healthy production workloads"

      # Cluster-specific
      - name: us-east-cluster
        filter: "cluster: us-east-1"
        description: "US East cluster only"

    # Override or disable standard filters
    standardFilters:
      enabled: true          # Include auto-generated filters (default: true)
      exclude:               # Optionally exclude specific standard filters
        - unhealthy-only
```

### Standard Filters (Auto-Generated)

These are always generated based on the known node schema:

| Name | Filter | Description |
|------|--------|-------------|
| `all` | `.*` | All discovered nodes |
| `statefulsets` | `targetType: statefulset` | StatefulSet workloads only |
| `deployments` | `targetType: deployment` | Deployment workloads only |
| `helm-releases` | `targetType: helm-release` | Helm releases only |
| `healthy` | `healthy: true` | Healthy workloads only |
| `unhealthy` | `healthy: false` | Unhealthy workloads |
| `healthy-statefulsets` | `targetType: statefulset healthy: true` | Healthy StatefulSets |
| `unhealthy-statefulsets` | `targetType: statefulset healthy: false` | Unhealthy StatefulSets |

### Generated Job Output

The merged filters appear as job option values:

```yaml
# Generated job with filter presets
- name: petfindbystatusquery
  options:
  - name: node_filter
    description: "Select target nodes"
    enforced: false           # Allow custom input too
    values:
      # Standard filters
      - '.*'                                              # all
      - 'targetType: statefulset'                         # statefulsets
      - 'targetType: deployment'                          # deployments
      - 'targetType: helm-release'                        # helm-releases
      - 'healthy: true'                                   # healthy
      - 'healthy: false'                                  # unhealthy
      - 'targetType: statefulset healthy: true'           # healthy-statefulsets
      - 'targetType: statefulset healthy: false'          # unhealthy-statefulsets
      # Custom filters (from operator.yaml)
      - 'targetNamespace: prod.*'                         # production
      - 'targetNamespace: staging.*'                      # staging
      - 'targetNamespace: prod.* healthy: true'           # prod-healthy
      - 'cluster: us-east-1'                              # us-east-cluster
    value: '.*'               # Default to all nodes

  nodefilters:
    dispatch:
      threadcount: '1'
      keepgoing: 'false'
    filter: '${option.node_filter}'
```

## Implementation

### Generator Code Structure

```go
// pkg/generator/rundeck_filters.go

type NodeFilter struct {
    Name        string
    Filter      string
    Description string
    Standard    bool   // true if auto-generated
}

var StandardNodeFilters = []NodeFilter{
    // Match all (default)
    {Name: "all", Filter: ".*", Description: "All discovered nodes"},

    // By workload type
    {Name: "statefulsets", Filter: "targetType: statefulset", Description: "StatefulSet workloads only"},
    {Name: "deployments", Filter: "targetType: deployment", Description: "Deployment workloads only"},
    {Name: "helm-releases", Filter: "targetType: helm-release", Description: "Helm releases only"},

    // By health
    {Name: "healthy", Filter: "healthy: true", Description: "Healthy workloads only"},
    {Name: "unhealthy", Filter: "healthy: false", Description: "Unhealthy workloads"},

    // Combined type + health
    {Name: "healthy-statefulsets", Filter: "targetType: statefulset healthy: true", Description: "Healthy StatefulSets"},
    {Name: "unhealthy-statefulsets", Filter: "targetType: statefulset healthy: false", Description: "Unhealthy StatefulSets"},
}

func (g *RundeckGenerator) buildNodeFilterOptions(config *OperatorConfig) []NodeFilter {
    var filters []NodeFilter

    // Add standard filters (unless disabled)
    if config.Rundeck.StandardFilters.Enabled {
        for _, sf := range StandardNodeFilters {
            if !contains(config.Rundeck.StandardFilters.Exclude, sf.Name) {
                sf.Standard = true
                filters = append(filters, sf)
            }
        }
    }

    // Add custom filters from config
    for _, cf := range config.Rundeck.NodeFilters {
        filters = append(filters, NodeFilter{
            Name:        cf.Name,
            Filter:      cf.Filter,
            Description: cf.Description,
            Standard:    false,
        })
    }

    return filters
}
```

### Filter Documentation Generation

Generate a reference file for users:

```yaml
# Generated: rundeck-project/node-filters.yaml

# Available Node Filters
# Use these values with the node_filter job option

filters:
  # === Standard Filters ===
  - name: all
    filter: ".*"
    description: All discovered nodes

  - name: statefulsets
    filter: "targetType: statefulset"
    description: StatefulSet workloads only

  # ... etc ...

  # === Custom Filters ===
  - name: production
    filter: "targetNamespace: prod.*"
    description: Production namespace workloads
```

## Implementation Tasks

1. Add the `nodeFilters` section to the config schema
2. Implement the standard filter list in `pkg/generator/rundeck_filters.go`
3. Update job templates to use `${option.node_filter}`
4. Generate filter documentation/reference file

## References

- [Nodes | Rundeck Docs](https://docs.rundeck.com/docs/manual/05-nodes.html)
- [JOB-YAML | Rundeck Docs](https://docs.rundeck.com/docs/manual/document-format-reference/job-yaml-v12.html)
- [Saved Node Filter GitHub Issue](https://github.com/rundeck/rundeck/issues/3182)
