# cel-test

A CLI utility for testing CEL (Common Expression Language) expressions used in Aggregate and Bundle CRDs generated by openapi-operator-gen.

## Overview

`cel-test` allows you to validate CEL expressions before deploying to Kubernetes. It supports multiple data sources:

- **JSON data files** - Test data in JSON format
- **Aggregate/Bundle CR YAML files** - Extract expressions and status data from CRs
- **Resources YAML files** - Child resource CRs with spec data
- **Kubernetes cluster** - Fetch live resources from a cluster or envtest

## Installation

```bash
# Build from source
cd openapi-operator-gen
go build -o cel-test ./cmd/cel-test/

# Or use make
make build-cel-test
```

## Quick Start

```bash
# Evaluate a simple expression with default test data
cel-test eval "summary.total"

# Evaluate with a JSON data file
cel-test eval "resources.size()" --data testdata.json

# Evaluate expressions from an Aggregate CR
cel-test expressions --cr aggregate.yaml

# Start interactive mode
cel-test interactive --data testdata.json
```

## Commands

### `eval` - Evaluate a Single Expression

```bash
cel-test eval [expression] [flags]

Flags:
  -d, --data string       JSON file with test data
  -c, --cr string         Aggregate/Bundle CR YAML file (uses status for test data)
  -r, --resources string  YAML file with referenced child CRs (provides spec data)
  -m, --mock              Generate mock status data from CR resourceSelectors
  -k, --kinds strings     Kind variable names (e.g., orders,pets,users)
  -s, --summary string    Summary JSON (e.g., '{"total":10,"synced":8}')

Kubernetes Flags (fetch data directly from cluster):
      --kubeconfig string    Path to kubeconfig file (defaults to ~/.kube/config)
  -n, --namespace string     Kubernetes namespace to fetch from
      --api-group string     API group for the resources (e.g., petstore.example.com)
      --api-version string   API version for the resources (default "v1alpha1")
      --envtest              Use envtest instead of real cluster
      --crd-paths strings    Paths to CRD YAML files (required with --envtest)
```

**Examples:**

```bash
# Basic expression evaluation
cel-test eval "summary.synced * 100 / summary.total"

# With data file
cel-test eval "resources.filter(r, r.status.state == 'Failed').size()" --data testdata.json

# Using CR status data with child resource specs
cel-test eval "sum(orders.map(r, r.spec.quantity))" \
  --cr aggregate.yaml \
  --resources resources.yaml

# Fetch directly from Kubernetes and evaluate
cel-test eval "orders.size()" \
  --kinds Order,Pet \
  --api-group petstore.example.com

# Use CR to determine kinds and fetch from Kubernetes
cel-test eval "resources.filter(r, r.status.state == 'Synced').size()" \
  --cr aggregate.yaml \
  --api-group petstore.example.com
```

### `expressions` - List and Evaluate CR Expressions

Reads an Aggregate or Bundle CR and evaluates all `derivedValues` expressions.

```bash
cel-test expressions --cr <file> [flags]

Flags:
  -c, --cr string         Aggregate/Bundle CR YAML file (required)
  -d, --data string       JSON file with test data for evaluation
  -r, --resources string  YAML file with referenced child CRs
  -m, --mock              Generate mock status data from CR resourceSelectors
  -k, --kinds strings     Kind variable names (e.g., orders,pets,users)

Kubernetes Flags (fetch data directly from cluster):
      --kubeconfig string    Path to kubeconfig file (defaults to ~/.kube/config)
  -n, --namespace string     Kubernetes namespace to fetch from
      --api-group string     API group for the resources (e.g., petstore.example.com)
      --api-version string   API version for the resources (default "v1alpha1")
      --envtest              Use envtest instead of real cluster
      --crd-paths strings    Paths to CRD YAML files (required with --envtest)
```

**Examples:**

```bash
# List and evaluate all expressions in an Aggregate CR
cel-test expressions --cr petstore-aggregate.yaml

# With mock data for testing without status
cel-test expressions --cr petstore-aggregate.yaml --mock

# With actual resource specs
cel-test expressions --cr petstore-aggregate.yaml --resources resources.yaml

# Fetch resources directly from Kubernetes and evaluate expressions
cel-test expressions --cr petstore-aggregate.yaml --api-group petstore.example.com
```

### `interactive` - Interactive Mode

Start an interactive session for testing multiple expressions.

```bash
cel-test interactive [flags]

Flags:
  -d, --data string       JSON file with test data
  -c, --cr string         Aggregate/Bundle CR YAML file
  -r, --resources string  YAML file with referenced child CRs
  -m, --mock              Generate mock status data
  -k, --kinds strings     Kind variable names (e.g., orders,pets,users)
  --history-size int      Maximum number of history entries (default 100)

Kubernetes Flags (fetch data directly from cluster):
      --kubeconfig string    Path to kubeconfig file (defaults to ~/.kube/config)
  -n, --namespace string     Kubernetes namespace to fetch from
      --api-group string     API group for the resources (e.g., petstore.example.com)
      --api-version string   API version for the resources (default "v1alpha1")
      --envtest              Use envtest instead of real cluster
      --crd-paths strings    Paths to CRD YAML files (required with --envtest)
```

**Keyboard Shortcuts:**

| Key | Action |
|-----|--------|
| Up/Down | Navigate command history |
| Left/Right | Move cursor |
| Ctrl+A | Move to beginning of line |
| Ctrl+E | Move to end of line |
| Ctrl+U | Clear line before cursor |
| Ctrl+K | Clear line after cursor |
| Ctrl+W | Delete word before cursor |
| Ctrl+L | Clear screen |
| Ctrl+C | Cancel current input |
| Ctrl+D | Exit |

**Interactive Commands:**

| Command | Description |
|---------|-------------|
| `help`, `h`, `?` | Show help |
| `data` | Show current test data |
| `expressions`, `expr` | Show and evaluate derived value expressions from CR |
| `history` | Show command history |
| `reload` | Reload test data from file |
| `exit`, `quit`, `q` | Exit interactive mode |

### `fetch` - Fetch Resources from Kubernetes

Fetch resources from a Kubernetes cluster for CEL testing.

```bash
cel-test fetch [flags]

Flags:
      --kubeconfig string    Path to kubeconfig file (defaults to ~/.kube/config)
  -n, --namespace string     Kubernetes namespace to fetch from (defaults to all)
      --api-group string     API group for the resources (required)
      --api-version string   API version for the resources (default "v1alpha1")
  -k, --kinds strings        Resource kinds to fetch (e.g., Order,Pet,User)
      --envtest              Use envtest instead of real cluster
      --crd-paths strings    Paths to CRD YAML files (required with --envtest)
  -c, --cr string            Aggregate/Bundle CR YAML file to get kinds from
  -e, --eval string          CEL expression to evaluate after fetching
  -o, --output string        Output file to save fetched data as JSON
      --output-yaml string   Output file to save fetched resources as YAML
```

**Examples:**

```bash
# Fetch from current kubeconfig context
cel-test fetch --kinds Order,Pet,User --api-group petstore.example.com

# Fetch from a specific namespace
cel-test fetch --kinds Order,Pet --namespace my-namespace --api-group petstore.example.com

# Use envtest (for testing without a real cluster)
cel-test fetch --envtest --crd-paths ./config/crd/bases --kinds Order,Pet --api-group petstore.example.com

# Fetch and evaluate an expression directly
cel-test fetch --kinds Order --api-group petstore.example.com --eval "orders.size()"

# Extract kinds from an Aggregate CR
cel-test fetch --cr aggregate.yaml --api-group petstore.example.com

# Save fetched data as JSON (for use with --data)
cel-test fetch --kinds Order,Pet --api-group petstore.example.com --output data.json

# Save fetched resources as YAML (for use with --resources)
cel-test fetch --kinds Order,Pet --api-group petstore.example.com --output-yaml resources.yaml
```

### `example` - Generate Example Test Data

Generate example test data JSON to stdout.

```bash
cel-test example > testdata.json
```

## Available Variables

| Variable | Type | Description |
|----------|------|-------------|
| `resources` | `list<map>` | All resources in the aggregate/bundle |
| `summary` | `map<string,int>` | Counts: total, synced, failed, pending, skipped |
| `<kind>s` | `list<map>` | Kind-specific lists (e.g., `orders`, `pets`, `users`) |

Each resource object contains:
- `kind` - Resource kind (e.g., "Order", "Pet")
- `metadata` - Map with `name`, `namespace`, `labels`, `annotations`
- `spec` - Map containing all spec fields from the CR
- `status` - Map containing all status fields from the CR

## Available Functions

### Aggregate Functions

| Function | Description | Example |
|----------|-------------|---------|
| `sum(list)` | Sum of numeric values | `sum(orders.map(r, r.spec.quantity))` |
| `max(list)` | Maximum value | `max(orders.map(r, r.spec.quantity))` |
| `min(list)` | Minimum value | `min(orders.map(r, r.spec.quantity))` |
| `avg(list)` | Average value | `avg(orders.map(r, r.spec.quantity))` |

### Standard CEL Functions

| Function | Description | Example |
|----------|-------------|---------|
| `size()` | List length | `resources.size()` |
| `filter(r, cond)` | Filter list | `resources.filter(r, r.status.state == 'Synced')` |
| `map(r, expr)` | Transform list | `resources.map(r, r.metadata.name)` |
| `exists(r, cond)` | Any match | `resources.exists(r, r.status.state == 'Failed')` |
| `all(r, cond)` | All match | `resources.all(r, r.status.state == 'Synced')` |
| `has(field)` | Check field exists | `has(r.spec.quantity)` |

## Example Expressions

```bash
# Calculate sync percentage
cel-test eval "summary.total > 0 ? (summary.synced * 100) / summary.total : 0"

# Check if all resources are synced
cel-test eval "summary.total > 0 && summary.synced == summary.total"

# Count failed resources
cel-test eval "resources.filter(r, r.status.state == 'Failed').size()"

# Get names of failed resources
cel-test eval "resources.filter(r, r.status.state == 'Failed').map(r, r.metadata.name)"

# Sum order quantities (with null check)
cel-test eval "sum(orders.map(r, has(r.spec.quantity) ? r.spec.quantity : 0))"

# Average price of synced pets
cel-test eval "avg(pets.filter(r, r.status.state == 'Synced').map(r, r.spec.price))"

# Count resources by kind
cel-test eval "orders.size()"
cel-test eval "pets.size()"

# Filter by labels
cel-test eval "resources.filter(r, has(r.metadata.labels) && r.metadata.labels.tier == 'backend').size()"
```

## Data Sources

### 1. JSON Data File (`--data`)

```json
{
  "summary": {
    "total": 10,
    "synced": 8,
    "failed": 1,
    "pending": 1,
    "skipped": 0
  },
  "resources": [
    {
      "kind": "Order",
      "metadata": {"name": "order-1", "namespace": "default"},
      "spec": {"quantity": 5},
      "status": {"state": "Synced"}
    }
  ],
  "kindLists": {
    "orders": [...]
  }
}
```

### 2. Aggregate/Bundle CR (`--cr`)

Uses the CR's status data for evaluation:

```yaml
apiVersion: petstore.example.com/v1alpha1
kind: PetstoreAggregate
metadata:
  name: my-aggregate
spec:
  derivedValues:
    - name: syncPercentage
      expression: "summary.total > 0 ? (summary.synced * 100) / summary.total : 0"
status:
  summary:
    total: 6
    synced: 4
  resources:
    - kind: Order
      name: order-1
      state: Synced
```

### 3. Resources YAML (`--resources`)

Provides spec data for resources referenced in aggregate status:

```yaml
apiVersion: petstore.example.com/v1alpha1
kind: Order
metadata:
  name: order-1
  namespace: default
spec:
  id: 101
  quantity: 5
---
apiVersion: petstore.example.com/v1alpha1
kind: Pet
metadata:
  name: pet-1
  namespace: default
spec:
  id: 1001
  name: "Buddy"
```

### 4. Kubernetes Cluster (`fetch`)

Fetch live resources directly from a cluster:

```bash
# Fetch and save as JSON
cel-test fetch --kinds Order,Pet --api-group petstore.example.com --output data.json
cel-test eval "orders.size()" --data data.json

# Fetch and save as YAML for use with --resources
cel-test fetch --kinds Order,Pet --api-group petstore.example.com --output-yaml resources.yaml
cel-test expressions --cr aggregate.yaml --resources resources.yaml
```

## Workflow Examples

### Testing Before Deployment

```bash
# 1. Create your aggregate CR with derivedValues
# 2. Generate mock data to test expressions
cel-test expressions --cr my-aggregate.yaml --mock

# 3. Or use actual resources from cluster (two options):

# Option A: Fetch directly during evaluation (simplest)
cel-test expressions --cr my-aggregate.yaml --api-group myapp.example.com

# Option B: Save resources to file first (for repeated testing)
cel-test fetch --cr my-aggregate.yaml --api-group myapp.example.com --output-yaml resources.yaml
cel-test expressions --cr my-aggregate.yaml --resources resources.yaml
```

### Interactive Development

```bash
# Start interactive mode with your data
cel-test interactive --cr my-aggregate.yaml --resources resources.yaml

# Or fetch directly from Kubernetes
cel-test interactive --cr my-aggregate.yaml --api-group myapp.example.com

# Try expressions interactively
cel> summary.total
=> 10 (int64)
cel> resources.filter(r, r.status.state == 'Failed').size()
=> 2 (int64)
cel> orders.map(r, r.spec.quantity)
=> [5, 10, 3] ([]interface {})
cel> sum(orders.map(r, r.spec.quantity))
=> 18 (float64)
```

### CI/CD Integration

```bash
# Validate all expressions in aggregate CR evaluate without errors
cel-test expressions --cr my-aggregate.yaml --mock
if [ $? -ne 0 ]; then
  echo "CEL expression validation failed"
  exit 1
fi
```

## Troubleshooting

### "no kinds specified"

When using `fetch`, specify kinds via `--kinds` flag or provide a `--cr` file with `resourceSelectors`.

### Empty spec data

When using `--cr` with status data, the spec fields are empty by default. Use `--resources` to provide the actual resource specs:

```bash
cel-test eval "orders[0].spec.quantity" --cr aggregate.yaml --resources resources.yaml
```

### Expression errors

Use `has()` to check for optional fields:

```bash
# Instead of: r.spec.quantity
# Use: has(r.spec.quantity) ? r.spec.quantity : 0
```

## License

Apache License 2.0
