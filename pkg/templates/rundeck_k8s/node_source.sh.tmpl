#!/bin/bash
# Generated by openapi-operator-gen {{ .GeneratorVersion }}
# Node source script for Rundeck resource model discovery (Kubernetes pod execution)
# Discovers Kubernetes workloads (Helm releases, StatefulSets, Deployments) as Rundeck nodes.
# Node attributes (targetType, targetValue, targetNamespace) map to kubectl plugin --target-* flags.
set -euo pipefail

K8S_TOKEN=$(curl -sf \
  -H 'X-Rundeck-Auth-Token: letmein99' \
  -H 'Accept: application/x-rundeck-data-password' \
  'http://localhost:4440/api/14/storage/keys/project/{{ .PluginName }}-operator-k8s/k8s-token')

K8S_URL=$(curl -sf \
  -H 'X-Rundeck-Auth-Token: letmein99' \
  'http://localhost:4440/api/14/project/{{ .PluginName }}-operator-k8s/config' \
  | grep -oE '"project\.globals\.k8s_url":"[^"]*"' | sed 's/.*:"\([^"]*\)"/\1/')

IMAGE="${PLUGIN_RUNNER_IMAGE:-{{ .PluginName }}-kubectl-plugin:latest}"
PLUGIN_NS="${PLUGIN_NAMESPACE:-{{ .Namespace }}}"
SA="${PLUGIN_SERVICE_ACCOUNT:-{{ .PluginName }}-plugin-runner}"
POD="plugin-nodes-$(date +%s)-$RANDOM"

kubectl --server="$K8S_URL" --token="$K8S_TOKEN" --insecure-skip-tls-verify \
  run "$POD" --image="$IMAGE" --restart=Never --rm -i --quiet --image-pull-policy=Never \
  -n "$PLUGIN_NS" \
  --overrides='{"spec":{"serviceAccountName":"'"$SA"'"}}' \
  -- {{ .PluginName }} nodes -n {{ .Namespace }}
