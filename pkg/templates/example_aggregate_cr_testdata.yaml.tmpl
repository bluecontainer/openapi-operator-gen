# Generated by openapi-operator-gen {{ .GeneratorVersion }}
# Example {{ .AggregateKind }} CR without status (spec only)
# This demonstrates creating an aggregate CR for testing
#
# Usage with cel-test:
#   cel-test expressions --cr testdata/aggregate.yaml
#   cel-test expressions --cr testdata/aggregate.yaml --resources testdata/resources.yaml
apiVersion: {{ .APIGroup }}/{{ .APIVersion }}
kind: {{ .AggregateKind }}
metadata:
  name: {{ .AppName }}-aggregate
  namespace: default
spec:
  resourceSelectors:
{{- range .ResourceKinds }}
    - kind: {{ . }}
{{- end }}
  aggregationStrategy: AllHealthy
  derivedValues:
    - name: syncPercentage
      expression: "summary.total > 0 ? (summary.synced * 100) / summary.total : 0"
    - name: allSynced
      expression: "summary.total > 0 && summary.synced == summary.total"
    - name: failedResources
      expression: "resources.filter(r, r.status.state == 'Failed').size()"
{{- range $i, $kind := .ResourceKinds }}
    - name: {{ $kind | lower }}Count
      expression: "resources.filter(r, r.kind == '{{ $kind }}').size()"
{{- end }}
