#!/bin/bash
# Generated by openapi-operator-gen {{ .GeneratorVersion }}
# Rundeck Resource Model Source script for {{ .PluginName }} operator
# Discovers Kubernetes workloads (Helm releases, StatefulSets, Deployments) as Rundeck nodes.
# Node attributes (targetType, targetValue, targetNamespace) map to kubectl plugin --target-* flags.

# Debug: redirect stderr to file and enable bash tracing
# exec 2>>/tmp/nodes-debug.log
# set -x

set -euo pipefail

# Log all RD_ environment variables for debugging
env | grep RD_ >&2 || true

# Configuration from Rundeck plugin (passed via RD_CONFIG_* env vars)
K8S_TOKEN="${RD_CONFIG_K8S_TOKEN:-}"
K8S_URL="${RD_CONFIG_K8S_URL:-}"
NAMESPACE="${RD_CONFIG_NAMESPACE:-{{ .Namespace }}}"
EXECUTION_MODE="${RD_CONFIG_EXECUTION_MODE:-native}"
DOCKER_IMAGE="${RD_CONFIG_DOCKER_IMAGE:-{{ .PluginName }}-kubectl-plugin:latest}"
DOCKER_NETWORK="${RD_CONFIG_DOCKER_NETWORK:-host}"
PLUGIN_NAMESPACE="${RD_CONFIG_PLUGIN_NAMESPACE:-{{ .Namespace }}}"
SERVICE_ACCOUNT="${RD_CONFIG_SERVICE_ACCOUNT:-{{ .PluginName }}-plugin-runner}"

if [ -z "$K8S_TOKEN" ]; then
  echo "Error: K8S_TOKEN not provided" >&2
  exit 1
fi

if [ -z "$K8S_URL" ]; then
  echo "Error: K8S_URL not provided" >&2
  exit 1
fi

case "$EXECUTION_MODE" in
  native)
    # Native execution: kubectl plugin runs directly on Rundeck host
    export PATH=/home/rundeck/server/data:$PATH
    kubectl-{{ .PluginName }} nodes -n "$NAMESPACE" \
      --server="$K8S_URL" \
      --token="$K8S_TOKEN" \
      --insecure-skip-tls-verify
    ;;

  docker)
    # Docker execution: kubectl plugin runs in Docker container
    export PATH=/home/rundeck/server/data:$PATH
    docker run --rm --network "$DOCKER_NETWORK" "$DOCKER_IMAGE" \
      {{ .PluginName }} nodes -n "$NAMESPACE" \
      --server="$K8S_URL" \
      --token="$K8S_TOKEN" \
      --insecure-skip-tls-verify
    ;;

  kubernetes)
    # Kubernetes execution: kubectl plugin runs in ephemeral K8s pod
    export PATH=/home/rundeck/server/data:$PATH
    POD="plugin-nodes-$(date +%s)-$RANDOM"
    kubectl --server="$K8S_URL" --token="$K8S_TOKEN" --insecure-skip-tls-verify \
      run "$POD" --image="$DOCKER_IMAGE" --restart=Never --rm -i --quiet --image-pull-policy=Never \
      -n "$PLUGIN_NAMESPACE" \
      --overrides='{"spec":{"serviceAccountName":"'"$SERVICE_ACCOUNT"'"}}' \
      -- {{ .PluginName }} nodes -n "$NAMESPACE"
    ;;

  *)
    echo "Error: Unknown execution mode: $EXECUTION_MODE" >&2
    exit 1
    ;;
esac
