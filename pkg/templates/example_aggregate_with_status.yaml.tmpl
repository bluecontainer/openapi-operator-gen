# Generated by openapi-operator-gen {{ .GeneratorVersion }}
# Example {{ .AggregateKind }} CR with populated status
# This demonstrates using cel-test with status data from a CR
#
# Usage with cel-test:
#   cel-test expressions --cr testdata/aggregate-with-status.yaml
#   cel-test expressions --cr testdata/aggregate-with-status.yaml --resources testdata/resources.yaml
apiVersion: {{ .APIGroup }}/{{ .APIVersion }}
kind: {{ .AggregateKind }}
metadata:
  name: {{ .AppName }}-aggregate-with-status
  namespace: default
spec:
  resourceSelectors:
{{- range .ResourceKinds }}
    - kind: {{ . }}
{{- end }}
  aggregationStrategy: AllHealthy
  derivedValues:
    - name: syncPercentage
      expression: "summary.total > 0 ? (summary.synced * 100) / summary.total : 0"
    - name: allSynced
      expression: "summary.total > 0 && summary.synced == summary.total"
    - name: failedResources
      expression: "resources.filter(r, r.status.state == 'Failed').size()"
{{- range $i, $kind := .ResourceKinds }}
    - name: {{ $kind | lower }}Count
      expression: "resources.filter(r, r.kind == '{{ $kind }}').size()"
{{- end }}
status:
  state: Degraded
  message: "{{ .TotalResources | add -2 }} of {{ .TotalResources }} resources synced"
  summary:
    total: {{ .TotalResources }}
    synced: {{ .TotalResources | add -2 }}
    failed: 1
    pending: 1
  resources:
{{- $resourceIndex := 0 }}
{{- range $kindIndex, $kind := .ResourceKinds }}
{{- $kindLower := $kind | lower }}
    # {{ $kind }} resources
    - kind: {{ $kind }}
      name: my-{{ $kindLower }}
      namespace: default
      state: Synced
      externalID: "ext-my-{{ $kindLower }}"
      message: "Successfully synced"
    - kind: {{ $kind }}
      name: critical-{{ $kindLower }}
      namespace: default
      state: Synced
      externalID: "ext-critical-{{ $kindLower }}"
      message: "Successfully synced"
    - kind: {{ $kind }}
      name: test-{{ $kindLower }}-alpha
      namespace: default
{{- if eq $kindIndex 0 }}
      state: Failed
      externalID: ""
      message: "API returned 500 error"
{{- else }}
      state: Synced
      externalID: "ext-test-{{ $kindLower }}-alpha"
      message: "Successfully synced"
{{- end }}
    - kind: {{ $kind }}
      name: test-{{ $kindLower }}-beta
      namespace: default
{{- if eq $kindIndex 1 }}
      state: Pending
      externalID: ""
      message: "Waiting for API"
{{- else }}
      state: Synced
      externalID: "ext-test-{{ $kindLower }}-beta"
      message: "Successfully synced"
{{- end }}
    - kind: {{ $kind }}
      name: {{ $kindLower }}-001
      namespace: default
      state: Synced
      externalID: "ext-{{ $kindLower }}-001"
      message: "Successfully synced"
    - kind: {{ $kind }}
      name: {{ $kindLower }}-002
      namespace: default
      state: Synced
      externalID: "ext-{{ $kindLower }}-002"
      message: "Successfully synced"
{{- end }}
  lastAggregationTime: "{{ .Timestamp }}"
