<!-- Generated by openapi-operator-gen {{ .GeneratorVersion }} -->
# {{ .TitleAppName }} Operator

A Kubernetes operator generated from an OpenAPI specification that manages {{ .AppName }} resources by syncing Custom Resources with the backing REST API.

## Overview

This operator was generated using [openapi-operator-gen](https://github.com/bluecontainer/openapi-operator-gen) from an OpenAPI specification. It provides Kubernetes-native management of {{ .AppName }} resources through Custom Resource Definitions (CRDs).

### Generator Command

This operator was generated with the following command:

```bash
{{ .GeneratorCmd }}
```

To regenerate after modifying the OpenAPI spec, run the same command.

## Features

- Kubernetes-native resource management via CRDs
- Automatic synchronization between CRs and the REST API
- Drift detection and reconciliation
- Support for multiple endpoint discovery modes
- Per-CR targeting for multi-tenant scenarios
- OpenTelemetry instrumentation for observability

## Prerequisites

- Go 1.21+
- Kubernetes cluster (1.25+)
- kubectl configured to access your cluster
- Access to the {{ .AppName }} REST API

## Building

```bash
# Download dependencies
go mod tidy

# Generate code (deep copy methods, CRDs, RBAC)
make generate manifests rbac

# Build the operator binary
make build

# Build Docker image
make docker-build IMG=<your-registry>/{{ .AppName }}-operator:latest
```

## Testing

This operator includes comprehensive tests using Go's testing framework and Ginkgo/Gomega for BDD-style integration tests.

### Unit Tests

Unit tests run quickly without external dependencies and use mock HTTP servers to simulate the REST API:

```bash
make test
```

Unit tests cover:
- Controller reconciliation logic
- HTTP request/response handling
- Error scenarios (404, 500, timeouts, rate limiting)
- URL construction and path parameter handling
- Status updates and state transitions

### Integration Tests

Integration tests use [envtest](https://book.kubebuilder.io/reference/envtest.html) to run a real Kubernetes API server (etcd + kube-apiserver) locally. This validates CRD schemas, RBAC, and controller behavior against a real Kubernetes environment.

```bash
# Install envtest binaries (first time only)
make envtest

# Run integration tests
make test-integration
```

Integration tests cover:
- CRD creation with schema validation
- Resource updates and spec changes
- Resource deletion and cleanup
- Required field validation

### All Tests

Run both unit and integration tests together:

```bash
make test-all
```

### Test Coverage

Test coverage reports are generated in `cover.out`:

```bash
make test
go tool cover -html=cover.out -o coverage.html
```

## Custom Resource Definitions

This operator manages the following CRDs:

| Kind | Type | Description |
|------|------|-------------|
{{- range .CRDs }}
{{- if .IsQuery }}
| `{{ .Kind }}` | Query | One-shot or periodic read-only query |
{{- else if .IsAction }}
| `{{ .Kind }}` | Action | One-shot or periodic action |
{{- else }}
| `{{ .Kind }}` | Resource | Full CRUD lifecycle management |
{{- end }}
{{- end }}
{{- if .HasAggregate }}
| `{{ .TitleAppName }}Aggregate` | Aggregate | Aggregates status from multiple resources with CEL expressions |
{{- end }}

### Resource CRDs

Resource CRDs represent entities in the REST API with full CRUD support:
- **Create**: When a CR is created, the operator POSTs to the REST API
- **Read**: The operator GETs current state and updates CR status
- **Update**: Spec changes trigger PUT requests to sync state
- **Delete**: CR deletion triggers DELETE on the REST API

### Query CRDs

Query CRDs execute read-only queries against the REST API:
- **One-shot mode** (default): Query executes once when CR is created, results stored in status
- **Periodic mode**: Set `spec.queryInterval` to re-execute at regular intervals
- Results stored in CR status
- No external resource creation
- Re-executes automatically when spec changes

Example one-shot query:
```yaml
apiVersion: {{ .APIGroup }}/{{ .APIVersion }}
kind: PetFindbystatusQuery
metadata:
  name: available-pets
spec:
  status: available
  # No queryInterval - executes once
```

Example periodic query:
```yaml
apiVersion: {{ .APIGroup }}/{{ .APIVersion }}
kind: PetFindbystatusQuery
metadata:
  name: available-pets-monitor
spec:
  status: available
  queryInterval: 30s  # Re-execute every 30 seconds
```

### Action CRDs

Action CRDs execute operations on the REST API:
- One-shot execution by default
- Optional periodic re-execution via `reExecuteInterval`
- Results stored in CR status

{{- if .HasAggregate }}

### Aggregate CRD

The `{{ .TitleAppName }}Aggregate` CRD aggregates status information from multiple resources into a single view. This is useful for monitoring the health of multiple related resources and computing derived values.

#### Aggregation Strategies

| Strategy | Description |
|----------|-------------|
| `AllHealthy` | Healthy only if ALL selected resources are Synced (default) |
| `AnyHealthy` | Healthy if ANY selected resource is Synced |
| `Quorum` | Healthy if more than half of selected resources are Synced |

#### Resource Selectors

Select resources by kind, labels, or name patterns:

```yaml
apiVersion: {{ .APIGroup }}/{{ .APIVersion }}
kind: {{ .TitleAppName }}Aggregate
metadata:
  name: all-resources
spec:
  resourceSelectors:
    - kind: Order
    - kind: Pet
      matchLabels:
        environment: production
    - kind: User
      namePattern: "^admin-.*"
  aggregationStrategy: AllHealthy
```

#### CEL Derived Values

Compute custom values using [CEL (Common Expression Language)](https://github.com/google/cel-spec) expressions:

```yaml
apiVersion: {{ .APIGroup }}/{{ .APIVersion }}
kind: {{ .TitleAppName }}Aggregate
metadata:
  name: with-metrics
spec:
  resourceSelectors:
    - kind: Order
    - kind: Pet
  derivedValues:
    # Calculate percentage of synced resources
    - name: syncPercentage
      expression: "summary.total > 0 ? (summary.synced * 100) / summary.total : 0"

    # Check if all resources are synced
    - name: allSynced
      expression: "summary.total > 0 && summary.synced == summary.total"

    # Count failed resources
    - name: failedResources
      expression: "resources.filter(r, r.status.state == 'Failed').size()"
```

#### CEL Variables

| Variable | Type | Description |
|----------|------|-------------|
| `resources` | `list` | All aggregated resources across all kinds |
| `summary` | `map` | Object with `total`, `synced`, `failed`, `pending` counts |
| `<kind>s` | `list` | Kind-specific list (lowercase plural, e.g., `orders`, `pets`) |

Each resource contains `kind`, `metadata` (name, namespace, labels, annotations), `spec`, and `status` fields.

#### CEL Aggregate Functions

Custom aggregate functions are available:

| Function | Description | Example |
|----------|-------------|---------|
| `sum(list)` | Sum of numeric values | `sum(orders.map(r, r.spec.quantity))` |
| `max(list)` | Maximum value | `max(orders.map(r, r.spec.quantity))` |
| `min(list)` | Minimum value | `min(orders.map(r, r.spec.quantity))` |
| `avg(list)` | Average value | `avg(orders.map(r, r.spec.quantity))` |

Example:

```yaml
derivedValues:
  - name: totalOrderQuantity
    expression: "sum(orders.map(r, has(r.spec.quantity) ? r.spec.quantity : 0))"
  - name: maxOrderQuantity
    expression: "max(orders.map(r, has(r.spec.quantity) ? r.spec.quantity : 0))"
  - name: avgOrderQuantity
    expression: "avg(orders.map(r, has(r.spec.quantity) ? r.spec.quantity : 0))"
```

#### Aggregate Status

The aggregate status includes:

| Field | Description |
|-------|-------------|
| `state` | `Pending`, `Healthy`, `Degraded`, or `Unknown` |
| `summary` | Counts: `total`, `synced`, `failed`, `pending` |
| `resources` | List of individual resource statuses |
| `computedValues` | Results of CEL expression evaluations |
| `lastAggregationTime` | Timestamp of last aggregation |

{{- end }}

## Running the Operator

### Option 1: No Global Configuration (Per-CR Targeting)

Run without endpoint flags - each CR must specify its target:

```bash
./bin/manager
```

CRs must include one of:
- `spec.targetHelmRelease` - Target a Helm release
- `spec.targetStatefulSet` - Target a StatefulSet
- `spec.targetDeployment` - Target a Deployment

### Option 2: Static URL Mode

Use a fixed base URL for all API requests:

```bash
./bin/manager --base-url http://{{ .AppName }}-api:8080
```

### Option 3: StatefulSet Discovery

Discover endpoints from StatefulSet pods:

```bash
./bin/manager \
  --statefulset-name {{ .AppName }} \
  --namespace default \
  --port 8080
```

### Option 4: Deployment Discovery

Discover endpoints from Deployment pods:

```bash
./bin/manager \
  --deployment-name {{ .AppName }} \
  --namespace default \
  --port 8080
```

### Option 5: Helm Release Discovery

Auto-discover workload from a Helm release:

```bash
./bin/manager \
  --helm-release {{ .AppName }} \
  --namespace default \
  --port 8080
```

## Configuration Flags

| Flag | Description | Default |
|------|-------------|---------|
| `--base-url` | Static REST API base URL | (optional) |
| `--statefulset-name` | StatefulSet for endpoint discovery | (optional) |
| `--deployment-name` | Deployment for endpoint discovery | (optional) |
| `--helm-release` | Helm release for endpoint discovery | (optional) |
| `--namespace` | Namespace of the workload | Operator namespace |
| `--port` | REST API port on pods | `8080` |
| `--scheme` | URL scheme (http/https) | `http` |
| `--strategy` | Endpoint selection strategy | `round-robin` |
| `--health-path` | Health check path | `/health` |

### Endpoint Selection Strategies

| Strategy | Description |
|----------|-------------|
| `round-robin` | Distribute requests across healthy pods |
| `leader-only` | Always use pod-0 (StatefulSet only) |
| `any-healthy` | Use any single healthy pod |
| `all-healthy` | Fan-out to all healthy pods |
| `by-ordinal` | Route to specific pod via `targetPodOrdinal` |

{{- if .CRDs }}
## Example Usage

### Creating a Resource

```yaml
apiVersion: {{ .APIGroup }}/{{ .APIVersion }}
kind: {{ (index .CRDs 0).Kind }}
metadata:
  name: example
spec:
  # Resource-specific fields here
  targetHelmRelease: {{ .AppName }}  # Optional: per-CR targeting
```

### Per-CR Targeting

Override the operator's global endpoint for specific CRs:

```yaml
apiVersion: {{ .APIGroup }}/{{ .APIVersion }}
kind: {{ (index .CRDs 0).Kind }}
metadata:
  name: example
spec:
  # Target a specific Helm release
  targetHelmRelease: {{ .AppName }}-prod
  targetNamespace: production

  # Or target a specific StatefulSet
  # targetStatefulSet: {{ .AppName }}-api
  # targetPodOrdinal: 0  # Optional: specific pod

  # Or target a specific Deployment
  # targetDeployment: {{ .AppName }}-api
```

### Importing Existing Resources

Reference an existing resource in the REST API:

```yaml
apiVersion: {{ .APIGroup }}/{{ .APIVersion }}
kind: {{ (index .CRDs 0).Kind }}
metadata:
  name: imported-resource
spec:
  externalIDRef: "existing-id-123"
  # Spec fields will be synced to match the external resource
```

### Read-Only Observation

Observe a resource without modifying it:

```yaml
apiVersion: {{ .APIGroup }}/{{ .APIVersion }}
kind: {{ (index .CRDs 0).Kind }}
metadata:
  name: observed-resource
spec:
  externalIDRef: "existing-id-123"
  readOnly: true
```
{{- end }}

## Deploying to Kubernetes

### Install CRDs

```bash
make install
```

### Deploy the Operator

```bash
# Build and push image
make docker-build docker-push IMG=<your-registry>/{{ .AppName }}-operator:latest

# Deploy to cluster
make deploy IMG=<your-registry>/{{ .AppName }}-operator:latest
```

### Deploy to kind (local development)

```bash
make kind-deploy IMG={{ .AppName }}-operator:latest
```

### Undeploy

```bash
make undeploy
make uninstall
```

## Helm Chart

This operator can be packaged as a Helm chart for easier distribution and deployment.

### Generate Helm Chart

```bash
# Generate Helm chart from kustomize manifests
make helm
```

This creates a Helm chart in `chart/{{ .AppName }}/` using [helmify](https://github.com/arttor/helmify).

### Install with Helm

```bash
# Build and push the operator image first
make docker-build docker-push IMG=<your-registry>/{{ .AppName }}-operator:latest

# Install the Helm chart
make helm-install IMG=<your-registry>/{{ .AppName }}-operator:latest

# Or install manually
helm install {{ .AppName }} ./chart/{{ .AppName }} \
  -n {{ .AppName }}-system \
  --create-namespace \
  --set image.repository=<your-registry>/{{ .AppName }}-operator \
  --set image.tag=latest
```

### Upgrade

```bash
make helm-upgrade IMG=<your-registry>/{{ .AppName }}-operator:latest
```

### Uninstall

```bash
make helm-uninstall
```

### Package for Distribution

```bash
helm package ./chart/{{ .AppName }}
```

## Environment Variables

| Variable | Flag Equivalent |
|----------|-----------------|
| `REST_API_BASE_URL` | `--base-url` |
| `STATEFULSET_NAME` | `--statefulset-name` |
| `DEPLOYMENT_NAME` | `--deployment-name` |
| `HELM_RELEASE` | `--helm-release` |
| `WORKLOAD_NAMESPACE` | `--namespace` |
| `SERVICE_NAME` | `--service` |

## Observability

This operator includes OpenTelemetry instrumentation. Enable it by setting:

```bash
export OTEL_EXPORTER_OTLP_ENDPOINT=otel-collector:4317
```

### Metrics

- `reconcile_total` - Total reconciliations by status
- `reconcile_duration_seconds` - Reconciliation duration
- `api_call_total` - REST API calls by method and status
- `api_call_duration_seconds` - API call duration

### Tracing

Spans are created for:
- `Reconcile` - Full reconciliation cycle
- `getResource` - GET requests
- `createResource` - POST requests
- `updateResource` - PUT requests
- `deleteFromEndpoint` - DELETE requests

## Status Fields

### Resource CRs

| Field | Description |
|-------|-------------|
| `state` | `Pending`, `Syncing`, `Synced`, `Failed`, `Observed`, `NotFound` |
| `externalID` | ID of the resource in the REST API |
| `lastSyncTime` | Last successful sync timestamp |
| `message` | Human-readable status message |
| `driftDetected` | Whether spec differs from external state |

### Query CRs

| Field | Description |
|-------|-------------|
| `state` | `Pending`, `Querying`, `Queried`, `Failed` |
| `lastQueryTime` | Last query execution timestamp |
| `resultCount` | Number of results returned |
| `results` | Query results data |

### Action CRs

| Field | Description |
|-------|-------------|
| `state` | `Pending`, `Executing`, `Completed`, `Failed` |
| `executedAt` | First execution timestamp |
| `completedAt` | Last completion timestamp |
| `executionCount` | Number of executions |
| `httpStatusCode` | HTTP response status code |
| `result` | Action result data |

## License

Apache License 2.0

---

Generated by [openapi-operator-gen](https://github.com/bluecontainer/openapi-operator-gen)
