# Generated by openapi-operator-gen {{ .GeneratorVersion }}
# Example {{ .BundleKind }} CR with populated status
# This demonstrates using cel-test with status data from a CR
#
# Usage with cel-test:
#   cel-test expressions --cr testdata/bundle-with-status.yaml
#   cel-test expressions --cr testdata/bundle-with-status.yaml --resources testdata/resources.yaml
apiVersion: {{ .APIGroup }}/{{ .APIVersion }}
kind: {{ .BundleKind }}
metadata:
  name: {{ .AppName }}-bundle-with-status
  namespace: default
spec:
  # Resources to include in the bundle
  resources:
{{- range .ResourceKinds }}
    - kind: {{ . }}
      name: my-{{ . | lower }}
{{- end }}
  # Derived values using CEL expressions
  derivedValues:
    - name: syncPercentage
      expression: "summary.total > 0 ? (summary.synced * 100) / summary.total : 0"
    - name: allSynced
      expression: "summary.total > 0 && summary.synced == summary.total"
    - name: failedResources
      expression: "resources.filter(r, r.status.state == 'Failed').size()"
{{- range $i, $kind := .ResourceKinds }}
    - name: {{ $kind | lower }}Count
      expression: "resources.filter(r, r.kind == '{{ $kind }}').size()"
{{- end }}
status:
  state: Synced
  message: "All resources synced successfully"
  summary:
    total: {{ len .ResourceKinds }}
    synced: {{ len .ResourceKinds }}
    failed: 0
    pending: 0
  resources:
{{- range $kindIndex, $kind := .ResourceKinds }}
{{- $kindLower := $kind | lower }}
    - kind: {{ $kind }}
      name: my-{{ $kindLower }}
      namespace: default
      state: Synced
      externalID: "ext-my-{{ $kindLower }}"
      message: "Successfully synced"
{{- end }}
  derivedValues:
    syncPercentage: 100
    allSynced: true
    failedResources: 0
{{- range $i, $kind := .ResourceKinds }}
    {{ $kind | lower }}Count: 1
{{- end }}
  lastReconcileTime: "{{ .Timestamp }}"
