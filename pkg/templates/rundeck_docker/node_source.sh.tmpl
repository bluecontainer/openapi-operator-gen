#!/bin/bash
# Generated by openapi-operator-gen {{ .GeneratorVersion }}
# Node source script for Rundeck resource model discovery (Docker execution)
# Discovers Kubernetes workloads (Helm releases, StatefulSets, Deployments) as Rundeck nodes.
# Node attributes (targetType, targetValue, targetNamespace) map to kubectl plugin --target-* flags.
set -euo pipefail

K8S_TOKEN=$(curl -sf \
  -H 'X-Rundeck-Auth-Token: letmein99' \
  -H 'Accept: application/x-rundeck-data-password' \
  'http://localhost:4440/api/14/storage/keys/project/{{ .PluginName }}-operator-docker/k8s-token')

K8S_URL=$(curl -sf \
  -H 'X-Rundeck-Auth-Token: letmein99' \
  'http://localhost:4440/api/14/project/{{ .PluginName }}-operator-docker/config' \
  | grep -oE '"project\.globals\.k8s_url":"[^"]*"' | sed 's/.*:"\([^"]*\)"/\1/')

IMAGE="${PLUGIN_RUNNER_IMAGE:-{{ .PluginName }}-kubectl-plugin:latest}"
NET="${DOCKER_NETWORK:-host}"

docker run --rm --network "$NET" "$IMAGE" \
  {{ .PluginName }} nodes -n {{ .Namespace }} \
  --server="$K8S_URL" \
  --token="$K8S_TOKEN" \
  --insecure-skip-tls-verify
