<!-- Generated by openapi-operator-gen v0.0.10-10-ge5a6a04-dirty -->
# Petstore Operator

A Kubernetes operator generated from an OpenAPI specification that manages petstore resources by syncing Custom Resources with the backing REST API.

## Overview

This operator was generated using [openapi-operator-gen](https://github.com/bluecontainer/openapi-operator-gen) from an OpenAPI specification. It provides Kubernetes-native management of petstore resources through Custom Resource Definitions (CRDs).

### Generator Command

This operator was generated with the following command:

```bash
openapi-operator-gen generate \
  --spec examples/petstore.1.0.27.yaml \
  --output examples/generated \
  --group petstore.example.com \
  --version v1alpha1 \
  --module github.com/bluecontainer/petstore-operator \
  --aggregate \
  --bundle
```

To regenerate after modifying the OpenAPI spec, run the same command.

## Features

- Kubernetes-native resource management via CRDs
- Automatic synchronization between CRs and the REST API
- Drift detection and reconciliation
- Support for multiple endpoint discovery modes
- Per-CR targeting for multi-tenant scenarios
- OpenTelemetry instrumentation for observability

## Prerequisites

- Go 1.21+
- Kubernetes cluster (1.25+)
- kubectl configured to access your cluster
- Access to the petstore REST API

## Building

```bash
# Download dependencies
go mod tidy

# Generate code (deep copy methods, CRDs, RBAC)
make generate manifests rbac

# Build the operator binary
make build

# Build Docker image
make docker-build IMG=<your-registry>/petstore-operator:latest
```

## Testing

This operator includes comprehensive tests using Go's testing framework and Ginkgo/Gomega for BDD-style integration tests.

### Unit Tests

Unit tests run quickly without external dependencies and use mock HTTP servers to simulate the REST API:

```bash
make test
```

Unit tests cover:
- Controller reconciliation logic
- HTTP request/response handling
- Error scenarios (404, 500, timeouts, rate limiting)
- URL construction and path parameter handling
- Status updates and state transitions

### Integration Tests

Integration tests use [envtest](https://book.kubebuilder.io/reference/envtest.html) to run a real Kubernetes API server (etcd + kube-apiserver) locally. This validates CRD schemas, RBAC, and controller behavior against a real Kubernetes environment.

```bash
# Install envtest binaries (first time only)
make envtest

# Run integration tests
make test-integration
```

Integration tests cover:
- CRD creation with schema validation
- Resource updates and spec changes
- Resource deletion and cleanup
- Required field validation

### All Tests

Run both unit and integration tests together:

```bash
make test-all
```

### Test Coverage

Test coverage reports are generated in `cover.out`:

```bash
make test
go tool cover -html=cover.out -o coverage.html
```

## Custom Resource Definitions

This operator manages the following CRDs:

| Kind | Type | Description |
|------|------|-------------|
| `Order` | Resource | Full CRUD lifecycle management |
| `Pet` | Resource | Full CRUD lifecycle management |
| `User` | Resource | Full CRUD lifecycle management |
| `PetFindbystatusQuery` | Query | One-shot or periodic read-only query |
| `PetFindbytagsQuery` | Query | One-shot or periodic read-only query |
| `StoreInventoryQuery` | Query | One-shot or periodic read-only query |
| `UserLoginQuery` | Query | One-shot or periodic read-only query |
| `UserLogoutQuery` | Query | One-shot or periodic read-only query |
| `PetUploadimageAction` | Action | One-shot or periodic action |
| `UserCreatewithlistAction` | Action | One-shot or periodic action |
| `PetstoreAggregate` | Aggregate | Aggregates status from multiple resources with CEL expressions |
| `PetstoreBundle` | Bundle | Inline composition - creates and manages multiple child resources |

### Resource CRDs

Resource CRDs represent entities in the REST API with full CRUD support:
- **Create**: When a CR is created, the operator POSTs to the REST API
- **Read**: The operator GETs current state and updates CR status
- **Update**: Spec changes trigger PUT requests to sync state
- **Delete**: CR deletion triggers DELETE on the REST API
- **Periodic sync**: By default, syncs every 30 seconds. Use `spec.executionInterval` to customize or set to `0` to disable periodic sync

### Execution Interval

All CRD types support the `executionInterval` field to control periodic reconciliation:

| CRD Type | Not Specified | Value > 0 | Value = 0 |
|----------|---------------|-----------|-----------|
| Resource (CRUD) | Uses controller default (30s) | Periodic at specified interval | Disable periodic sync (only on spec changes) |
| Query | One-shot (no requeue) | Periodic at specified interval | One-shot |
| Action | One-shot (no requeue) | Periodic at specified interval | One-shot |

### Query CRDs

Query CRDs execute read-only queries against the REST API:
- **One-shot mode** (default): Query executes once when CR is created, results stored in status
- **Periodic mode**: Set `spec.executionInterval` to re-execute at regular intervals
- Results stored in CR status
- No external resource creation
- Re-executes automatically when spec changes

Example one-shot query:
```yaml
apiVersion: petstore.example.com/v1alpha1
kind: PetFindbystatusQuery
metadata:
  name: available-pets
spec:
  status: available
  # No executionInterval - executes once
```

Example periodic query:
```yaml
apiVersion: petstore.example.com/v1alpha1
kind: PetFindbystatusQuery
metadata:
  name: available-pets-monitor
spec:
  status: available
  executionInterval: 30s  # Re-execute every 30 seconds
```

### Action CRDs

Action CRDs execute operations on the REST API:
- One-shot execution by default
- Optional periodic re-execution via `executionInterval`
- Results stored in CR status

### Aggregate CRD

The `PetstoreAggregate` CRD aggregates status information from multiple resources into a single view. This is useful for monitoring the health of multiple related resources and computing derived values.

#### Supported Resource Types

The aggregate CRD can aggregate status from all CRD types:

| CRD Type | Success State | Timestamp Field |
|----------|---------------|-----------------|
| Resource (CRUD) | `Synced` or `Observed` | `lastSyncTime` |
| Query | `Queried` | `lastQueryTime` |
| Action | `Completed` | `lastExecutionTime` |

All CRD types use `Failed` state for failures and `Pending` for initial state.

#### Aggregation Strategies

| Strategy | Description |
|----------|-------------|
| `AllHealthy` | Healthy only if ALL selected resources are in success state (default) |
| `AnyHealthy` | Healthy if ANY selected resource is in success state |
| `Quorum` | Healthy if more than half of selected resources are in success state |

#### Resource Selection Methods

Two methods are available for selecting resources to aggregate:

1. **Explicit References** (`resources`): Reference specific resources by name
2. **Dynamic Selectors** (`resourceSelectors`): Select resources by kind, labels, or patterns

You can use either method or combine both in a single aggregate.

#### Explicit Resource References

Reference specific resources by name for precise control:

```yaml
apiVersion: petstore.example.com/v1alpha1
kind: PetstoreAggregate
metadata:
  name: specific-resources
spec:
  resources:
    - kind: Order
      name: my-order
    - kind: Pet
      name: my-pet
      namespace: other-ns  # Optional: defaults to aggregate's namespace
  aggregationStrategy: AllHealthy
```

#### Dynamic Resource Selectors

Select resources by kind, labels, or name patterns:

```yaml
apiVersion: petstore.example.com/v1alpha1
kind: PetstoreAggregate
metadata:
  name: all-resources
spec:
  resourceSelectors:
    - kind: Order
    - kind: Pet
      matchLabels:
        environment: production
    - kind: User
      namePattern: "^admin-.*"
  aggregationStrategy: AllHealthy
```

#### Combining Selection Methods

Use both explicit references and selectors together:

```yaml
apiVersion: petstore.example.com/v1alpha1
kind: PetstoreAggregate
metadata:
  name: mixed-selection
spec:
  # Explicitly include critical resources
  resources:
    - kind: Order
      name: critical-order
  # Also include all resources matching criteria
  resourceSelectors:
    - kind: Pet
      matchLabels:
        tier: backend
  aggregationStrategy: AllHealthy
```

#### Aggregating All CRD Types

Include Resource, Query, and Action CRDs in a single aggregate:

```yaml
apiVersion: petstore.example.com/v1alpha1
kind: PetstoreAggregate
metadata:
  name: all-types
spec:
  resourceSelectors:
    # CRUD Resources (state: Synced/Observed)
    - kind: Order
    - kind: Pet
    # Query CRDs (state: Queried)
    - kind: PetFindbystatusQuery
    # Action CRDs (state: Completed)
    - kind: PetUploadimageAction
  aggregationStrategy: AllHealthy
  derivedValues:
    # Count by CRD type using state
    - name: syncedResources
      expression: "resources.filter(r, r.status.state == 'Synced' || r.status.state == 'Observed').size()"
    - name: queriedCount
      expression: "resources.filter(r, r.status.state == 'Queried').size()"
    - name: completedActions
      expression: "resources.filter(r, r.status.state == 'Completed').size()"
```

#### CEL Derived Values

Compute custom values using [CEL (Common Expression Language)](https://github.com/google/cel-spec) expressions:

```yaml
apiVersion: petstore.example.com/v1alpha1
kind: PetstoreAggregate
metadata:
  name: with-metrics
spec:
  resourceSelectors:
    - kind: Order
    - kind: Pet
  derivedValues:
    # Calculate percentage of synced resources
    - name: syncPercentage
      expression: "summary.total > 0 ? (summary.synced * 100) / summary.total : 0"

    # Check if all resources are synced
    - name: allSynced
      expression: "summary.total > 0 && summary.synced == summary.total"

    # Count failed resources
    - name: failedResources
      expression: "resources.filter(r, r.status.state == 'Failed').size()"
```

#### CEL Variables

| Variable | Type | Description |
|----------|------|-------------|
| `resources` | `list` | All aggregated resources across all kinds |
| `summary` | `map` | Object with `total`, `synced`, `failed`, `pending` counts |
| `<kind>s` | `list` | Kind-specific list (lowercase plural, e.g., `orders`, `pets`) |

Each resource contains `kind`, `metadata` (name, namespace, labels, annotations), `spec`, and `status` fields.

#### CEL Aggregate Functions

Custom aggregate functions are available:

| Function | Description | Example |
|----------|-------------|---------|
| `sum(list)` | Sum of numeric values | `sum(orders.map(r, r.spec.quantity))` |
| `max(list)` | Maximum value | `max(orders.map(r, r.spec.quantity))` |
| `min(list)` | Minimum value | `min(orders.map(r, r.spec.quantity))` |
| `avg(list)` | Average value | `avg(orders.map(r, r.spec.quantity))` |

Example:

```yaml
derivedValues:
  - name: totalOrderQuantity
    expression: "sum(orders.map(r, has(r.spec.quantity) ? r.spec.quantity : 0))"
  - name: maxOrderQuantity
    expression: "max(orders.map(r, has(r.spec.quantity) ? r.spec.quantity : 0))"
  - name: avgOrderQuantity
    expression: "avg(orders.map(r, has(r.spec.quantity) ? r.spec.quantity : 0))"
```

#### Aggregate Status

The aggregate status includes:

| Field | Description |
|-------|-------------|
| `state` | `Pending`, `Healthy`, `Degraded`, or `Unknown` |
| `summary` | Counts: `total`, `synced`, `failed`, `pending` |
| `resources` | List of individual resource statuses |
| `computedValues` | Results of CEL expression evaluations |
| `lastAggregationTime` | Timestamp of last aggregation |

### Bundle CRD

The `PetstoreBundle` CRD allows you to define and manage multiple child resources as a single unit. This is useful for deploying related resources together with dependency ordering and lifecycle management.

#### Bundle Spec Structure

```yaml
apiVersion: petstore.example.com/v1alpha1
kind: PetstoreBundle
metadata:
  name: my-bundle
spec:
  # Optional: Target settings inherited by child resources
  target:
    helmRelease: my-release
    namespace: backend

  # Optional: Pause reconciliation
  paused: false

  # Optional: Sync wave for ordered deployment
  syncWave: 0

  # Resource definitions
  resources:
    - id: my-resource        # Unique identifier within the bundle
      kind: Pet              # CRD kind to create
      spec:                  # Spec for the child resource
        name: "Fluffy"
```

Child resources are created with owner references and automatically cleaned up when the bundle is deleted.

#### Automatic Dependency Derivation

Dependencies are automatically derived from `${resources.<id>...}` variable references in your specs. No explicit `dependsOn` needed when using variable references:

```yaml
apiVersion: petstore.example.com/v1alpha1
kind: PetstoreBundle
metadata:
  name: auto-deps-bundle
spec:
  resources:
    # Parent resource
    - id: parent
      kind: Pet
      spec:
        name: "Parent Pet"

    # Child - dependency on 'parent' is automatically derived
    - id: child
      kind: Pet
      spec:
        # This reference creates an implicit dependency on 'parent'
        name: "Child of ${resources.parent.status.externalID}"
```

The controller parses all spec fields and CEL expressions to find `${resources.<id>...}` patterns and automatically adds them to the dependency graph.

#### Explicit Dependencies

You can also explicitly declare dependencies when needed:

```yaml
spec:
  resources:
    - id: database
      kind: Pet
      spec:
        name: "Database"

    - id: app
      kind: Pet
      spec:
        name: "Application"
      dependsOn:
        - database  # Explicit dependency
```

Explicit and automatic dependencies are combined.

#### Conditional Resource Creation

Skip resource creation based on CEL conditions:

```yaml
spec:
  resources:
    - id: main
      kind: Pet
      spec:
        name: "Main Resource"

    - id: optional
      kind: Pet
      spec:
        name: "Optional Resource"
      skipWhen:
        - "resources.main.status.state != 'Synced'"
```

#### Ready Conditions

Define custom conditions for when a resource is considered ready:

```yaml
spec:
  resources:
    - id: backend
      kind: Pet
      spec:
        name: "Backend Service"
      readyWhen:
        - "resources.backend.status.state == 'Synced'"

    - id: frontend
      kind: Pet
      spec:
        name: "Frontend Service"
      dependsOn:
        - backend
      readyWhen:
        - "resources.frontend.status.state == 'Synced'"
```

#### Bundle Status

| Field | Description |
|-------|-------------|
| `state` | `Pending`, `Progressing`, `Ready`, `Degraded`, or `Paused` |
| `summary` | Counts: `total`, `ready`, `pending`, `failed` |
| `resources` | Per-resource status details |
| `lastReconcileTime` | Timestamp of last reconciliation |

Example status:

```yaml
status:
  state: Progressing
  message: "2 of 3 resources ready"
  summary:
    total: 3
    ready: 2
    pending: 1
    failed: 0
  resources:
    - id: parent
      kind: Pet
      name: my-bundle-parent
      state: Ready
    - id: child
      kind: Pet
      name: my-bundle-child
      state: Pending
      message: "Waiting for dependencies"
  lastReconcileTime: "2026-01-05T10:00:00Z"
```

## Running the Operator

### Option 1: No Global Configuration (Per-CR Targeting)

Run without endpoint flags - each CR must specify its target:

```bash
./bin/manager
```

CRs must include one of:
- `spec.target.helmRelease` - Target a Helm release
- `spec.target.statefulSet` - Target a StatefulSet
- `spec.target.deployment` - Target a Deployment

### Option 2: Static URL Mode

Use a fixed base URL for all API requests:

```bash
./bin/manager --base-url http://petstore-api:8080
```

### Option 3: StatefulSet Discovery

Discover endpoints from StatefulSet pods:

```bash
./bin/manager \
  --statefulset-name petstore \
  --namespace default \
  --port 8080
```

### Option 4: Deployment Discovery

Discover endpoints from Deployment pods:

```bash
./bin/manager \
  --deployment-name petstore \
  --namespace default \
  --port 8080
```

### Option 5: Helm Release Discovery

Auto-discover workload from a Helm release:

```bash
./bin/manager \
  --helm-release petstore \
  --namespace default \
  --port 8080
```

## Configuration Flags

| Flag | Description | Default |
|------|-------------|---------|
| `--base-url` | Static REST API base URL | (optional) |
| `--statefulset-name` | StatefulSet for endpoint discovery | (optional) |
| `--deployment-name` | Deployment for endpoint discovery | (optional) |
| `--helm-release` | Helm release for endpoint discovery | (optional) |
| `--namespace` | Namespace of the workload | Operator namespace |
| `--port` | REST API port on pods | `8080` |
| `--scheme` | URL scheme (http/https) | `http` |
| `--strategy` | Endpoint selection strategy | `round-robin` |
| `--health-path` | Health check path | `/health` |
| `--watch-labels` | Only watch CRs matching these labels | All labels |
| `--watch-namespaces` | Only watch CRs in these namespaces | All namespaces |
| `--namespace-scoped` | Only watch CRs in operator's own namespace | `false` |

### CR Filtering

Filter which CRs the operator watches using labels, namespaces, or both.

#### Namespace-Scoped Mode

Restrict the operator to only watch CRs in its own namespace:

```bash
./bin/manager --namespace-scoped
```

#### Watch Specific Namespaces

```bash
./bin/manager --watch-namespaces "ns1,ns2"
```

#### Watch by Labels (Sharding)

Run multiple operator instances that each handle a subset of CRs:

```bash
# Instance 1
./bin/manager --watch-labels "shard=1"

# Instance 2
./bin/manager --watch-labels "shard=2"
```

### Endpoint Selection Strategies

| Strategy | Description |
|----------|-------------|
| `round-robin` | Distribute requests across healthy pods |
| `leader-only` | Always use pod-0 (StatefulSet only) |
| `any-healthy` | Use any single healthy pod |
| `all-healthy` | Fan-out to all healthy pods |
| `by-ordinal` | Route to specific pod via `target.podOrdinal` |
## Example Usage

### Creating a Resource

```yaml
apiVersion: petstore.example.com/v1alpha1
kind: Order
metadata:
  name: example
spec:
  # Resource-specific fields here
  target:
    helmRelease: petstore  # Optional: per-CR targeting
```

### Per-CR Targeting

Override the operator's global endpoint for specific CRs:

```yaml
apiVersion: petstore.example.com/v1alpha1
kind: Order
metadata:
  name: example
spec:
  # Target a specific Helm release
  target:
    helmRelease: petstore-prod
    namespace: production

  # Or target a specific StatefulSet
  # target:
  #   statefulSet: petstore-api
  #   podOrdinal: 0  # Optional: specific pod

  # Or target a specific Deployment
  # target:
  #   deployment: petstore-api
```
### Importing Existing Resources

For CRDs with path parameters (e.g., `/pet/{petId}`), the ID field in the spec serves as the external reference:

```yaml
apiVersion: petstore.example.com/v1alpha1
kind: Order
metadata:
  name: imported-resource
spec:
  id: 12345  # References the existing resource by its ID
  # Other spec fields...
```

### Read-Only Observation

Observe a resource without modifying it:

```yaml
apiVersion: petstore.example.com/v1alpha1
kind: Order
metadata:
  name: observed-resource
spec:
  id: 12345  # ID of the resource to observe
  readOnly: true
```

## Deploying to Kubernetes

### Install CRDs

```bash
make install
```

### Deploy the Operator

```bash
# Build and push image
make docker-build docker-push IMG=<your-registry>/petstore-operator:latest

# Deploy to cluster
make deploy IMG=<your-registry>/petstore-operator:latest
```

### Deploy to kind (local development)

```bash
make kind-deploy IMG=petstore-operator:latest
```

### Undeploy

```bash
make undeploy
make uninstall
```

## Helm Chart

This operator can be packaged as a Helm chart for easier distribution and deployment.

### Generate Helm Chart

```bash
# Generate Helm chart from kustomize manifests
make helm
```

This creates a Helm chart in `chart/petstore/` using [helmify](https://github.com/arttor/helmify).

### Install with Helm

```bash
# Build and push the operator image first
make docker-build docker-push IMG=<your-registry>/petstore-operator:latest

# Install the Helm chart
make helm-install IMG=<your-registry>/petstore-operator:latest

# Or install manually
helm install petstore ./chart/petstore \
  -n petstore-system \
  --create-namespace \
  --set image.repository=<your-registry>/petstore-operator \
  --set image.tag=latest
```

### Upgrade

```bash
make helm-upgrade IMG=<your-registry>/petstore-operator:latest
```

### Uninstall

```bash
make helm-uninstall
```

### Package for Distribution

```bash
helm package ./chart/petstore
```

## Environment Variables

| Variable | Flag Equivalent |
|----------|-----------------|
| `REST_API_BASE_URL` | `--base-url` |
| `STATEFULSET_NAME` | `--statefulset-name` |
| `DEPLOYMENT_NAME` | `--deployment-name` |
| `HELM_RELEASE` | `--helm-release` |
| `WORKLOAD_NAMESPACE` | `--namespace` |
| `SERVICE_NAME` | `--service` |
| `WATCH_LABELS` | `--watch-labels` |
| `WATCH_NAMESPACES` | `--watch-namespaces` |
| `NAMESPACE_SCOPED` | `--namespace-scoped` (set to `true`) |

## Observability

This operator includes OpenTelemetry instrumentation. Enable it by setting:

```bash
export OTEL_EXPORTER_OTLP_ENDPOINT=otel-collector:4317
```

### Metrics

- `reconcile_total` - Total reconciliations by status
- `reconcile_duration_seconds` - Reconciliation duration
- `api_call_total` - REST API calls by method and status
- `api_call_duration_seconds` - API call duration

### Tracing

Spans are created for:
- `Reconcile` - Full reconciliation cycle
- `getResource` - GET requests
- `createResource` - POST requests
- `updateResource` - PUT requests
- `deleteFromEndpoint` - DELETE requests

## Status Fields

### Resource CRs

| Field | Description |
|-------|-------------|
| `state` | `Pending`, `Syncing`, `Synced`, `Failed`, `Observed`, `NotFound` |
| `externalID` | ID of the resource in the REST API |
| `lastSyncTime` | Last successful sync timestamp |
| `message` | Human-readable status message |
| `driftDetected` | Whether spec differs from external state |

### Query CRs

| Field | Description |
|-------|-------------|
| `state` | `Pending`, `Querying`, `Queried`, `Failed` |
| `lastQueryTime` | Last query execution timestamp |
| `resultCount` | Number of results returned |
| `results` | Query results data |

### Action CRs

| Field | Description |
|-------|-------------|
| `state` | `Pending`, `Executing`, `Completed`, `Failed` |
| `executedAt` | First execution timestamp |
| `completedAt` | Last completion timestamp |
| `executionCount` | Number of executions |
| `httpStatusCode` | HTTP response status code |
| `result` | Action result data |

### Bundle CRs

| Field | Description |
|-------|-------------|
| `state` | `Pending`, `Progressing`, `Ready`, `Degraded`, `Paused` |
| `summary.total` | Total number of resources |
| `summary.ready` | Resources in ready state |
| `summary.pending` | Resources pending creation |
| `summary.failed` | Resources in failed state |
| `resources` | Per-resource status list |
| `lastReconcileTime` | Last reconciliation timestamp |

## License

Apache License 2.0

---

Generated by [openapi-operator-gen](https://github.com/bluecontainer/openapi-operator-gen)
