#!/bin/bash
# Generated by openapi-operator-gen v0.0.10-26-g2bb48be-dirty
# Rundeck Resource Model Source script for petstore operator
# Discovers Kubernetes workloads (Helm releases, StatefulSets, Deployments) as Rundeck nodes.
# Node attributes (targetType, targetValue, targetNamespace) map to kubectl plugin --target-* flags.

# Debug: redirect stderr to file and enable bash tracing
# exec 2>>/tmp/nodes-debug.log
# set -x

set -euo pipefail

# Log all RD_ environment variables for debugging
env | grep RD_ >&2 || true

# Configuration from Rundeck plugin (passed via RD_CONFIG_* env vars)
K8S_TOKEN="${RD_CONFIG_K8S_TOKEN:-}"
K8S_URL="${RD_CONFIG_K8S_URL:-}"
NAMESPACE="${RD_CONFIG_NAMESPACE:-petstore-system}"
EXECUTION_MODE="${RD_CONFIG_EXECUTION_MODE:-native}"
DOCKER_IMAGE="${RD_CONFIG_DOCKER_IMAGE:-petstore-kubectl-plugin:latest}"
DOCKER_NETWORK="${RD_CONFIG_DOCKER_NETWORK:-host}"
PLUGIN_NAMESPACE="${RD_CONFIG_PLUGIN_NAMESPACE:-petstore-system}"
SERVICE_ACCOUNT="${RD_CONFIG_SERVICE_ACCOUNT:-petstore-plugin-runner}"
CLUSTER_NAME="${RD_CONFIG_CLUSTER_NAME:-}"
CLUSTER_TOKEN_SUFFIX="${RD_CONFIG_CLUSTER_TOKEN_SUFFIX:-}"

# Build cluster flags if provided
CLUSTER_FLAGS=""
[ -n "$CLUSTER_NAME" ] && CLUSTER_FLAGS="$CLUSTER_FLAGS --cluster-name=$CLUSTER_NAME"
[ -n "$K8S_URL" ] && CLUSTER_FLAGS="$CLUSTER_FLAGS --cluster-url=$K8S_URL"
[ -n "$CLUSTER_TOKEN_SUFFIX" ] && CLUSTER_FLAGS="$CLUSTER_FLAGS --cluster-token-suffix=$CLUSTER_TOKEN_SUFFIX"

if [ -z "$K8S_TOKEN" ]; then
  echo "Error: K8S_TOKEN not provided" >&2
  exit 1
fi

if [ -z "$K8S_URL" ]; then
  echo "Error: K8S_URL not provided" >&2
  exit 1
fi

case "$EXECUTION_MODE" in
  native)
    # Native execution: kubectl plugin runs directly on Rundeck host
    export PATH=/home/rundeck/server/data:$PATH
    kubectl-petstore nodes -n "$NAMESPACE" \
      --server="$K8S_URL" \
      --token="$K8S_TOKEN" \
      --insecure-skip-tls-verify \
      $CLUSTER_FLAGS
    ;;

  docker)
    # Docker execution: kubectl plugin runs in Docker container
    export PATH=/home/rundeck/server/data:$PATH
    docker run --rm --network "$DOCKER_NETWORK" "$DOCKER_IMAGE" \
      petstore nodes -n "$NAMESPACE" \
      --server="$K8S_URL" \
      --token="$K8S_TOKEN" \
      --insecure-skip-tls-verify \
      $CLUSTER_FLAGS
    ;;

  kubernetes)
    # Kubernetes execution: kubectl plugin runs in ephemeral K8s pod
    export PATH=/home/rundeck/server/data:$PATH
    POD="plugin-nodes-$(date +%s)-$RANDOM"
    kubectl --server="$K8S_URL" --token="$K8S_TOKEN" --insecure-skip-tls-verify \
      run "$POD" --image="$DOCKER_IMAGE" --restart=Never --rm -i --quiet --image-pull-policy=Never \
      -n "$PLUGIN_NAMESPACE" \
      --overrides='{"spec":{"serviceAccountName":"'"$SERVICE_ACCOUNT"'"}}' \
      -- petstore nodes -n "$NAMESPACE" $CLUSTER_FLAGS
    ;;

  *)
    echo "Error: Unknown execution mode: $EXECUTION_MODE" >&2
    exit 1
    ;;
esac
