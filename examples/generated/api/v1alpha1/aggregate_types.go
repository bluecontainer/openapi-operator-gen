/*
Copyright 2026 Generated by openapi-operator-gen v0.0.10-27-g49a94a0-dirty.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
*/

package v1alpha1

import (
	metav1 "k8s.io/apimachinery/pkg/apis/meta/v1"
)

// ResourceReference explicitly references a resource by name for aggregation
type ResourceReference struct {
	// Kind specifies the resource kind (e.g., "Pet", "Order")
	// +kubebuilder:validation:Required
	Kind string `json:"kind"`

	// Name is the resource name
	// +kubebuilder:validation:Required
	Name string `json:"name"`

	// Namespace is the resource namespace (defaults to the aggregate's namespace if not specified)
	// +optional
	Namespace string `json:"namespace,omitempty"`
}

// ResourceSelector defines how to select resources for aggregation using patterns and labels
type ResourceSelector struct {
	// Kind specifies the resource kind to select (e.g., "Pet", "Order")
	// +kubebuilder:validation:Required
	Kind string `json:"kind"`

	// NamePattern is a regex pattern to filter resources by name
	// +optional
	NamePattern string `json:"namePattern,omitempty"`

	// MatchLabels is a map of labels to match resources
	// +optional
	MatchLabels map[string]string `json:"matchLabels,omitempty"`
}

// DerivedValue defines a CEL expression to compute a derived value from aggregated resources
type DerivedValue struct {
	// Name is the unique name for this derived value
	// +kubebuilder:validation:Required
	// +kubebuilder:validation:Pattern=^[a-zA-Z][a-zA-Z0-9_]*$
	Name string `json:"name"`

	// Expression is a CEL expression that computes a value from the aggregated resources
	// Available variables:
	//   - resources: list of ALL resource objects across all kinds
	//   - summary: map with total, synced, failed, pending counts
	//   - <kind>s: kind-specific lists (e.g., orders, pets, users) - lowercase plural
	// Each resource object contains:
	//   - kind: string (e.g., "Order", "Pet", "User")
	//   - metadata: map with name, namespace, labels, annotations
	//   - spec: map containing all spec fields from the CR
	//   - status: map containing all status fields from the CR
	// Available aggregate functions:
	//   - sum(list): sum of numeric values in a list
	//   - max(list): maximum value in a list
	//   - min(list): minimum value in a list
	//   - avg(list): average of values in a list
	// Example expressions:
	//   - "summary.synced * 100 / summary.total" (percentage synced)
	//   - "orders.size()" (count orders using kind-specific variable)
	//   - "sum(orders.map(r, r.spec.quantity))" (sum of order quantities)
	//   - "avg(pets.filter(r, r.status.state == 'Synced').map(r, r.spec.price))" (avg synced pet price)
	//   - "max(orders.map(r, r.spec.quantity))" (max order quantity)
	// +kubebuilder:validation:Required
	Expression string `json:"expression"`
}

// ComputedValue holds the result of evaluating a CEL expression
type ComputedValue struct {
	// Name is the name of the derived value
	Name string `json:"name"`

	// Value is the computed result as a string (numbers, booleans, strings are all stringified)
	// +optional
	Value string `json:"value,omitempty"`

	// Error contains any error message if the expression failed to evaluate
	// +optional
	Error string `json:"error,omitempty"`
}

// AggregateSummary contains counts of aggregated resources by state
type AggregateSummary struct {
	// Total is the total number of matched resources
	Total int `json:"total"`

	// Synced is the number of resources in Synced state
	Synced int `json:"synced"`

	// Failed is the number of resources in Failed state
	Failed int `json:"failed"`

	// Pending is the number of resources in Pending or other states
	Pending int `json:"pending"`
}

// AggregatedResourceStatus represents the status of a single aggregated resource
type AggregatedResourceStatus struct {
	// Kind is the resource kind
	Kind string `json:"kind"`

	// Name is the resource name
	Name string `json:"name"`

	// Namespace is the resource namespace
	Namespace string `json:"namespace"`

	// State is the current state of the resource
	State string `json:"state"`

	// ExternalID is the external API ID if available
	// +optional
	ExternalID string `json:"externalID,omitempty"`

	// Message is the status message from the resource
	// +optional
	Message string `json:"message,omitempty"`

	// LastSyncTime is when the resource was last synced
	// +optional
	LastSyncTime *metav1.Time `json:"lastSyncTime,omitempty"`
}

// PetstoreAggregateSpec defines the desired state of PetstoreAggregate
type PetstoreAggregateSpec struct {
	// Resources specifies explicit resource references to aggregate by name.
	// Use this for precise control over which specific resources to include.
	// At least one of Resources or ResourceSelectors must be specified.
	// +optional
	Resources []ResourceReference `json:"resources,omitempty"`

	// ResourceSelectors specifies patterns to dynamically select resources for aggregation.
	// Use this to aggregate resources matching labels or name patterns.
	// At least one of Resources or ResourceSelectors must be specified.
	// +optional
	ResourceSelectors []ResourceSelector `json:"resourceSelectors,omitempty"`

	// AggregationStrategy determines how to combine resource statuses
	// +kubebuilder:validation:Enum=AllHealthy;AnyHealthy;Quorum
	// +kubebuilder:default=AllHealthy
	// +optional
	AggregationStrategy string `json:"aggregationStrategy,omitempty"`

	// DerivedValues defines CEL expressions to compute custom values from aggregated resources
	// +optional
	DerivedValues []DerivedValue `json:"derivedValues,omitempty"`

	// Paused stops reconciliation when true.
	// Useful for debugging or temporary suspension of aggregation.
	// +optional
	Paused bool `json:"paused,omitempty"`
}

// PetstoreAggregateStatus defines the observed state of PetstoreAggregate
type PetstoreAggregateStatus struct {
	// State represents the aggregated state
	// +kubebuilder:validation:Enum=Pending;Healthy;Degraded;Unknown;Paused
	// +optional
	State string `json:"state,omitempty"`

	// Message is a human-readable message about the current state
	// +optional
	Message string `json:"message,omitempty"`

	// Summary contains counts of resources by state
	// +optional
	Summary AggregateSummary `json:"summary,omitempty"`

	// Resources contains the status of each aggregated resource
	// +optional
	Resources []AggregatedResourceStatus `json:"resources,omitempty"`

	// ComputedValues contains the results of evaluating CEL expressions from spec.derivedValues
	// +optional
	ComputedValues []ComputedValue `json:"computedValues,omitempty"`

	// LastAggregationTime is when the status was last aggregated
	// +optional
	LastAggregationTime *metav1.Time `json:"lastAggregationTime,omitempty"`

	// Conditions represent the latest available observations of an object's state
	// +optional
	// +patchMergeKey=type
	// +patchStrategy=merge
	// +listType=map
	// +listMapKey=type
	Conditions []metav1.Condition `json:"conditions,omitempty" patchStrategy:"merge" patchMergeKey:"type"`

	// ObservedGeneration is the last observed generation
	// +optional
	ObservedGeneration int64 `json:"observedGeneration,omitempty"`
}

// +kubebuilder:object:root=true
// +kubebuilder:subresource:status
// +kubebuilder:resource:shortName=agg
// +kubebuilder:printcolumn:name="State",type=string,JSONPath=`.status.state`
// +kubebuilder:printcolumn:name="Total",type=integer,JSONPath=`.status.summary.total`
// +kubebuilder:printcolumn:name="Synced",type=integer,JSONPath=`.status.summary.synced`
// +kubebuilder:printcolumn:name="Failed",type=integer,JSONPath=`.status.summary.failed`
// +kubebuilder:printcolumn:name="Age",type=date,JSONPath=`.metadata.creationTimestamp`

// PetstoreAggregate is the Schema for aggregating status across multiple resources
type PetstoreAggregate struct {
	metav1.TypeMeta   `json:",inline"`
	metav1.ObjectMeta `json:"metadata,omitempty"`

	Spec   PetstoreAggregateSpec   `json:"spec,omitempty"`
	Status PetstoreAggregateStatus `json:"status,omitempty"`
}

// +kubebuilder:object:root=true

// PetstoreAggregateList contains a list of PetstoreAggregate
type PetstoreAggregateList struct {
	metav1.TypeMeta `json:",inline"`
	metav1.ListMeta `json:"metadata,omitempty"`
	Items           []PetstoreAggregate `json:"items"`
}

func init() {
	SchemeBuilder.Register(&PetstoreAggregate{}, &PetstoreAggregateList{})
}
