/*
Copyright 2026 Generated by openapi-operator-gen v0.0.9-23-g2e477da-dirty.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
*/

package v1alpha1

import (
	metav1 "k8s.io/apimachinery/pkg/apis/meta/v1"
	"k8s.io/apimachinery/pkg/runtime"
)

// BundleResourceSpec defines an embedded resource to create within a bundle
type BundleResourceSpec struct {
	// ID is a unique identifier for this resource within the bundle.
	// Used for referencing in CEL expressions: ${resources.<id>.status.externalID}
	// +kubebuilder:validation:Required
	// +kubebuilder:validation:Pattern=^[a-z][a-z0-9-]*$
	ID string `json:"id"`

	// Kind specifies the resource kind (e.g., "Pet", "Order")
	// +kubebuilder:validation:Required
	// +kubebuilder:validation:Enum=Order;Pet;User;PetFindbystatusQuery;PetFindbytagsQuery;StoreInventoryQuery;UserLoginQuery;UserLogoutQuery;PetUploadimageAction;UserCreatewithlistAction
	Kind string `json:"kind"`

	// Spec contains the resource specification.
	// CEL expressions can reference other resources: ${resources.pet.status.externalID}
	// +kubebuilder:validation:Required
	// +kubebuilder:pruning:PreserveUnknownFields
	Spec runtime.RawExtension `json:"spec"`

	// DependsOn lists resource IDs that must be synced before this resource is created.
	// This creates an implicit ordering via DAG resolution.
	// +optional
	DependsOn []string `json:"dependsOn,omitempty"`

	// ReadyWhen defines CEL conditions that must be true for the resource to be considered ready.
	// Example: "resources.pet.status.state == 'Synced'"
	// +optional
	ReadyWhen []string `json:"readyWhen,omitempty"`

	// SkipWhen defines CEL conditions that, if true, skip creating this resource.
	// Example: "schema.spec.skipOrder == true"
	// +optional
	SkipWhen []string `json:"skipWhen,omitempty"`
}

// BundleResourceStatus represents the status of an embedded resource
type BundleResourceStatus struct {
	// ID is the resource identifier from spec
	ID string `json:"id"`

	// Kind is the resource kind
	Kind string `json:"kind"`

	// Name is the generated CR name in the cluster
	Name string `json:"name"`

	// State is the current state of this resource
	// +kubebuilder:validation:Enum=Pending;Creating;Synced;Failed;Skipped
	State string `json:"state"`

	// ExternalID is the ID from the REST API (if available)
	// +optional
	ExternalID string `json:"externalID,omitempty"`

	// Message contains status details or error information
	// +optional
	Message string `json:"message,omitempty"`

	// Ready indicates if readyWhen conditions are met
	Ready bool `json:"ready"`

	// Skipped indicates if skipWhen conditions were met
	Skipped bool `json:"skipped,omitempty"`

	// LastSyncTime is when this resource was last synced
	// +optional
	LastSyncTime *metav1.Time `json:"lastSyncTime,omitempty"`
}

// BundleOperationState tracks the bundle sync operation
type BundleOperationState struct {
	// Phase is the current operation phase
	// +kubebuilder:validation:Enum=Pending;Running;Succeeded;Failed
	Phase string `json:"phase"`

	// Wave is the current sync wave being processed (if wave ordering is enabled)
	// +optional
	Wave int `json:"wave,omitempty"`

	// Message describes the current operation
	// +optional
	Message string `json:"message,omitempty"`

	// StartedAt is when the operation started
	// +optional
	StartedAt *metav1.Time `json:"startedAt,omitempty"`

	// FinishedAt is when the operation finished
	// +optional
	FinishedAt *metav1.Time `json:"finishedAt,omitempty"`

	// RetryCount tracks retry attempts for failed operations
	// +optional
	RetryCount int `json:"retryCount,omitempty"`
}

// BundleSummary contains resource counts for the bundle.
// This extends AggregateSummary with Bundle-specific fields.
type BundleSummary struct {
	// Total is the total number of resources in the bundle
	Total int `json:"total"`

	// Synced is the number of resources in Synced state
	Synced int `json:"synced"`

	// Failed is the number of resources in Failed state
	Failed int `json:"failed"`

	// Pending is the number of resources in Pending state
	Pending int `json:"pending"`

	// Skipped is the number of resources that were skipped (Bundle-specific)
	Skipped int `json:"skipped"`
}

// ToAggregateSummary converts BundleSummary to AggregateSummary for compatibility.
// Skipped resources are counted as Synced since they completed successfully.
func (s BundleSummary) ToAggregateSummary() AggregateSummary {
	return AggregateSummary{
		Total:   s.Total,
		Synced:  s.Synced + s.Skipped, // Skipped counts as successful
		Failed:  s.Failed,
		Pending: s.Pending,
	}
}

// BundleAggregatedHealth provides aggregate-style health reporting for Bundle resources.
// This mirrors the status fields from Aggregate CRD for consistency.
type BundleAggregatedHealth struct {
	// State represents the aggregated health state using Aggregate CRD semantics
	// +kubebuilder:validation:Enum=Pending;Healthy;Degraded;Unknown
	// +optional
	State string `json:"state,omitempty"`

	// Summary contains counts of resources by state (Aggregate-compatible format)
	// +optional
	Summary AggregateSummary `json:"summary,omitempty"`

	// Resources contains the status of each managed resource in Aggregate-compatible format
	// +optional
	Resources []AggregatedResourceStatus `json:"resources,omitempty"`

	// ComputedValues contains the results of evaluating CEL expressions from spec.derivedValues
	// +optional
	ComputedValues []ComputedValue `json:"computedValues,omitempty"`

	// LastAggregationTime is when the health was last aggregated
	// +optional
	LastAggregationTime *metav1.Time `json:"lastAggregationTime,omitempty"`
}

// PetstoreBundleSpec defines the desired state of PetstoreBundle
type PetstoreBundleSpec struct {
	// Resources defines the embedded resources to create.
	// Resources are created in dependency order based on DependsOn fields.
	// +kubebuilder:validation:Required
	// +kubebuilder:validation:MinItems=1
	Resources []BundleResourceSpec `json:"resources"`

	// SyncWaves enables wave-based ordering for resources.
	// When enabled, resources are grouped by dependency depth and processed in waves.
	// +optional
	SyncWaves bool `json:"syncWaves,omitempty"`

	// Paused stops reconciliation when true.
	// Useful for debugging or temporary suspension of resource management.
	// +optional
	Paused bool `json:"paused,omitempty"`

	// TargetHelmRelease specifies the Helm release for endpoint discovery.
	// This is applied to all child resources created by the bundle.
	// +optional
	TargetHelmRelease string `json:"targetHelmRelease,omitempty"`

	// TargetPod specifies a pod name to route requests to directly.
	// This is applied to all child resources created by the bundle.
	// +optional
	TargetPod string `json:"targetPod,omitempty"`

	// TargetNamespace specifies the namespace for the target workload.
	// This is applied to all child resources created by the bundle.
	// +optional
	TargetNamespace string `json:"targetNamespace,omitempty"`

	// TargetBaseURL specifies a static base URL for the REST API.
	// This is applied to all child resources created by the bundle.
	// Example: "http://api.example.com:8080"
	// +optional
	TargetBaseURL string `json:"targetBaseURL,omitempty"`

	// DerivedValues defines CEL expressions to compute custom values from bundle resources.
	// Uses the same syntax as Aggregate CRD for consistency.
	// Available variables:
	//   - resources: list of ALL resource objects in the bundle
	//   - summary: map with total, synced, failed, pending, skipped counts
	//   - <kind>s: kind-specific lists (e.g., orders, pets, users) - lowercase plural
	// Example expressions:
	//   - "summary.synced * 100 / summary.total" (percentage synced)
	//   - "sum(orders.map(r, r.spec.quantity))" (sum of order quantities)
	// +optional
	DerivedValues []DerivedValue `json:"derivedValues,omitempty"`

	// AggregationStrategy determines how to evaluate bundle health for AggregatedHealth status.
	// Uses the same strategies as Aggregate CRD for consistency.
	// +kubebuilder:validation:Enum=AllHealthy;AnyHealthy;Quorum
	// +kubebuilder:default=AllHealthy
	// +optional
	AggregationStrategy string `json:"aggregationStrategy,omitempty"`
}

// PetstoreBundleStatus defines the observed state of PetstoreBundle
type PetstoreBundleStatus struct {
	// State is the aggregated bundle state
	// +kubebuilder:validation:Enum=Pending;Syncing;Synced;Failed;Paused
	State string `json:"state,omitempty"`

	// Message describes the current state
	// +optional
	Message string `json:"message,omitempty"`

	// Resources contains per-resource status
	// +optional
	Resources []BundleResourceStatus `json:"resources,omitempty"`

	// OperationState tracks the current sync operation
	// +optional
	OperationState *BundleOperationState `json:"operationState,omitempty"`

	// Summary contains resource counts
	// +optional
	Summary BundleSummary `json:"summary,omitempty"`

	// AggregatedHealth provides Aggregate CRD-compatible health status.
	// This allows Bundle to be monitored using the same semantics as Aggregate CRD.
	// +optional
	AggregatedHealth *BundleAggregatedHealth `json:"aggregatedHealth,omitempty"`

	// ObservedGeneration is the last observed spec generation
	// +optional
	ObservedGeneration int64 `json:"observedGeneration,omitempty"`

	// Conditions represent the latest observations of the bundle state
	// +optional
	// +patchMergeKey=type
	// +patchStrategy=merge
	// +listType=map
	// +listMapKey=type
	Conditions []metav1.Condition `json:"conditions,omitempty" patchStrategy:"merge" patchMergeKey:"type"`
}

// +kubebuilder:object:root=true
// +kubebuilder:subresource:status
// +kubebuilder:resource:shortName=bundle
// +kubebuilder:printcolumn:name="State",type=string,JSONPath=`.status.state`
// +kubebuilder:printcolumn:name="Total",type=integer,JSONPath=`.status.summary.total`
// +kubebuilder:printcolumn:name="Synced",type=integer,JSONPath=`.status.summary.synced`
// +kubebuilder:printcolumn:name="Failed",type=integer,JSONPath=`.status.summary.failed`
// +kubebuilder:printcolumn:name="Age",type=date,JSONPath=`.metadata.creationTimestamp`

// PetstoreBundle creates and manages multiple resources as a single unit with dependency ordering
type PetstoreBundle struct {
	metav1.TypeMeta   `json:",inline"`
	metav1.ObjectMeta `json:"metadata,omitempty"`

	Spec   PetstoreBundleSpec   `json:"spec,omitempty"`
	Status PetstoreBundleStatus `json:"status,omitempty"`
}

// +kubebuilder:object:root=true

// PetstoreBundleList contains a list of PetstoreBundle
type PetstoreBundleList struct {
	metav1.TypeMeta `json:",inline"`
	metav1.ListMeta `json:"metadata,omitempty"`
	Items           []PetstoreBundle `json:"items"`
}

func init() {
	SchemeBuilder.Register(&PetstoreBundle{}, &PetstoreBundleList{})
}
