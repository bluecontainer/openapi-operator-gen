# Generated by openapi-operator-gen v0.0.7-5-g00a112e-dirty
# Example PetstoreAggregate CR - aggregates status from multiple resources
apiVersion: petstore.example.com/v1alpha1
kind: PetstoreAggregate
metadata:
  name: all-resources
  namespace: default
spec:
  # Select which resources to aggregate
  resourceSelectors:
    - kind: Order
    - kind: Pet
    - kind: User
  # Strategy for determining overall health
  # Options: AllHealthy (default), AnyHealthy, Quorum
  aggregationStrategy: AllHealthy
---
# Example with label selector
apiVersion: petstore.example.com/v1alpha1
kind: PetstoreAggregate
metadata:
  name: production-resources
  namespace: default
spec:
  resourceSelectors:
    - kind: Order
      matchLabels:
        environment: production
  aggregationStrategy: AllHealthy
---
# Example with name pattern (regex)
apiVersion: petstore.example.com/v1alpha1
kind: PetstoreAggregate
metadata:
  name: filtered-by-name
  namespace: default
spec:
  resourceSelectors:
    - kind: Order
      namePattern: "^test-.*"
  aggregationStrategy: AnyHealthy
---
# Example with Quorum strategy - healthy if majority are synced
apiVersion: petstore.example.com/v1alpha1
kind: PetstoreAggregate
metadata:
  name: quorum-check
  namespace: default
spec:
  resourceSelectors:
    - kind: Order
    - kind: Pet
    - kind: User
  aggregationStrategy: Quorum
---
# Example with CEL expressions for derived values
apiVersion: petstore.example.com/v1alpha1
kind: PetstoreAggregate
metadata:
  name: with-derived-values
  namespace: default
spec:
  resourceSelectors:
    - kind: Order
    - kind: Pet
    - kind: User
  aggregationStrategy: AllHealthy
  # Derived values using CEL expressions
  # Available variables:
  #   - resources: list of resource objects, each with:
  #       - kind: resource kind (e.g., "Order", "Pet")
  #       - metadata: { name, namespace, labels, annotations }
  #       - spec: the full spec fields as a map
  #       - status: the full status fields as a map
  #   - summary: object with total, synced, failed, pending counts
  # Available aggregate functions:
  #   - sum(list): sum of numeric values
  #   - max(list): maximum value
  #   - min(list): minimum value
  #   - avg(list): average value
  derivedValues:
    # Calculate percentage of synced resources
    - name: syncPercentage
      expression: "summary.total > 0 ? (summary.synced * 100) / summary.total : 0"
    # Check if all resources are synced
    - name: allSynced
      expression: "summary.total > 0 && summary.synced == summary.total"
    # Count resources in failed state using status field
    - name: failedResources
      expression: "resources.filter(r, r.status.state == 'Failed').size()"
    # Filter resources by kind
    - name: orderCount
      expression: "resources.filter(r, r.kind == 'Order').size()"
---
# Example with aggregate functions (sum, max, min, avg)
# Uses kind-specific variables: orders, pets, users (lowercase plural)
apiVersion: petstore.example.com/v1alpha1
kind: PetstoreAggregate
metadata:
  name: with-aggregate-functions
  namespace: default
spec:
  resourceSelectors:
    - kind: Order
    - kind: Pet
  aggregationStrategy: AllHealthy
  derivedValues:
    # Sum of all order quantities using kind-specific variable
    - name: totalOrderQuantity
      expression: "sum(orders.map(r, has(r.spec.quantity) ? r.spec.quantity : 0))"
    # Maximum quantity across all orders
    - name: maxOrderQuantity
      expression: "max(orders.map(r, has(r.spec.quantity) ? r.spec.quantity : 0))"
    # Average quantity across all orders
    - name: avgOrderQuantity
      expression: "avg(orders.map(r, has(r.spec.quantity) ? r.spec.quantity : 0))"
    # Count of orders vs pets
    - name: orderCount
      expression: "orders.size()"
    - name: petCount
      expression: "pets.size()"
    # Sum of quantities for only synced orders
    - name: syncedOrdersQuantity
      expression: "sum(orders.filter(r, r.status.state == 'Synced').map(r, has(r.spec.quantity) ? r.spec.quantity : 0))"
    # Compare across kinds - still possible with resources
    - name: totalResources
      expression: "resources.size()"
