---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  annotations:
    controller-gen.kubebuilder.io/version: v0.17.0
  name: petstorebundles.petstore.example.com
spec:
  group: petstore.example.com
  names:
    kind: PetstoreBundle
    listKind: PetstoreBundleList
    plural: petstorebundles
    shortNames:
    - bundle
    singular: petstorebundle
  scope: Namespaced
  versions:
  - additionalPrinterColumns:
    - jsonPath: .status.state
      name: State
      type: string
    - jsonPath: .status.summary.total
      name: Total
      type: integer
    - jsonPath: .status.summary.synced
      name: Synced
      type: integer
    - jsonPath: .status.summary.failed
      name: Failed
      type: integer
    - jsonPath: .metadata.creationTimestamp
      name: Age
      type: date
    name: v1alpha1
    schema:
      openAPIV3Schema:
        description: PetstoreBundle creates and manages multiple resources as a single
          unit with dependency ordering
        properties:
          apiVersion:
            description: |-
              APIVersion defines the versioned schema of this representation of an object.
              Servers should convert recognized schemas to the latest internal value, and
              may reject unrecognized values.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources
            type: string
          kind:
            description: |-
              Kind is a string value representing the REST resource this object represents.
              Servers may infer this from the endpoint the client submits requests to.
              Cannot be updated.
              In CamelCase.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds
            type: string
          metadata:
            type: object
          spec:
            description: PetstoreBundleSpec defines the desired state of PetstoreBundle
            properties:
              aggregationStrategy:
                default: AllHealthy
                description: |-
                  AggregationStrategy determines how to evaluate bundle health for AggregatedHealth status.
                  Uses the same strategies as Aggregate CRD for consistency.
                enum:
                - AllHealthy
                - AnyHealthy
                - Quorum
                type: string
              derivedValues:
                description: |-
                  DerivedValues defines CEL expressions to compute custom values from bundle resources.
                  Uses the same syntax as Aggregate CRD for consistency.
                  Available variables:
                    - resources: list of ALL resource objects in the bundle
                    - summary: map with total, synced, failed, pending, skipped counts
                    - <kind>s: kind-specific lists (e.g., orders, pets, users) - lowercase plural
                  Example expressions:
                    - "summary.synced * 100 / summary.total" (percentage synced)
                    - "sum(orders.map(r, r.spec.quantity))" (sum of order quantities)
                items:
                  description: DerivedValue defines a CEL expression to compute a
                    derived value from aggregated resources
                  properties:
                    expression:
                      description: |-
                        Expression is a CEL expression that computes a value from the aggregated resources
                        Available variables:
                          - resources: list of ALL resource objects across all kinds
                          - summary: map with total, synced, failed, pending counts
                          - <kind>s: kind-specific lists (e.g., orders, pets, users) - lowercase plural
                        Each resource object contains:
                          - kind: string (e.g., "Order", "Pet", "User")
                          - metadata: map with name, namespace, labels, annotations
                          - spec: map containing all spec fields from the CR
                          - status: map containing all status fields from the CR
                        Available aggregate functions:
                          - sum(list): sum of numeric values in a list
                          - max(list): maximum value in a list
                          - min(list): minimum value in a list
                          - avg(list): average of values in a list
                        Example expressions:
                          - "summary.synced * 100 / summary.total" (percentage synced)
                          - "orders.size()" (count orders using kind-specific variable)
                          - "sum(orders.map(r, r.spec.quantity))" (sum of order quantities)
                          - "avg(pets.filter(r, r.status.state == 'Synced').map(r, r.spec.price))" (avg synced pet price)
                          - "max(orders.map(r, r.spec.quantity))" (max order quantity)
                      type: string
                    name:
                      description: Name is the unique name for this derived value
                      pattern: ^[a-zA-Z][a-zA-Z0-9_]*$
                      type: string
                  required:
                  - expression
                  - name
                  type: object
                type: array
              paused:
                description: |-
                  Paused stops reconciliation when true.
                  Useful for debugging or temporary suspension of resource management.
                type: boolean
              resources:
                description: |-
                  Resources defines the embedded resources to create.
                  Resources are created in dependency order based on DependsOn fields.
                items:
                  description: BundleResourceSpec defines an embedded resource to
                    create within a bundle
                  properties:
                    dependsOn:
                      description: |-
                        DependsOn lists resource IDs that must be synced before this resource is created.
                        This creates an implicit ordering via DAG resolution.
                      items:
                        type: string
                      type: array
                    id:
                      description: |-
                        ID is a unique identifier for this resource within the bundle.
                        Used for referencing in CEL expressions: ${resources.<id>.status.externalID}
                      pattern: ^[a-z][a-z0-9-]*$
                      type: string
                    kind:
                      description: Kind specifies the resource kind (e.g., "Pet",
                        "Order")
                      enum:
                      - Order
                      - Pet
                      - User
                      - PetFindbystatusQuery
                      - PetFindbytagsQuery
                      - StoreInventoryQuery
                      - UserLoginQuery
                      - UserLogoutQuery
                      - PetUploadimageAction
                      - UserCreatewithlistAction
                      type: string
                    readyWhen:
                      description: |-
                        ReadyWhen defines CEL conditions that must be true for the resource to be considered ready.
                        Example: "resources.pet.status.state == 'Synced'"
                      items:
                        type: string
                      type: array
                    skipWhen:
                      description: |-
                        SkipWhen defines CEL conditions that, if true, skip creating this resource.
                        Example: "schema.spec.skipOrder == true"
                      items:
                        type: string
                      type: array
                    spec:
                      description: |-
                        Spec contains the resource specification.
                        CEL expressions can reference other resources: ${resources.pet.status.externalID}
                      type: object
                      x-kubernetes-preserve-unknown-fields: true
                  required:
                  - id
                  - kind
                  - spec
                  type: object
                minItems: 1
                type: array
              syncWaves:
                description: |-
                  SyncWaves enables wave-based ordering for resources.
                  When enabled, resources are grouped by dependency depth and processed in waves.
                type: boolean
              target:
                description: |-
                  Target specifies endpoint targeting configuration.
                  This is applied to all child resources created by the bundle.
                  If not specified, child resources use the operator's global configuration.
                properties:
                  baseURL:
                    description: |-
                      BaseURL specifies a static base URL for the REST API.
                      When set, overrides all other endpoint configuration.
                      Example: "http://api.example.com:8080"
                      Mutually exclusive with BaseURLs.
                    type: string
                  baseURLs:
                    description: |-
                      BaseURLs specifies multiple static base URLs for the REST API.
                      Operations will fan-out to all URLs (writes must succeed on all, reads use first success).
                      Example: ["http://api-1.example.com:8080", "http://api-2.example.com:8080"]
                      Mutually exclusive with BaseURL.
                    items:
                      type: string
                    type: array
                  deployment:
                    description: |-
                      Deployment specifies a Deployment name to route requests to.
                      When combined with HelmRelease, narrows discovery to only this Deployment within the release.
                    type: string
                  helmRelease:
                    description: |-
                      HelmRelease specifies a Helm release to discover the workload from.
                      The operator will find StatefulSets or Deployments with label app.kubernetes.io/instance=<HelmRelease>.
                    type: string
                  labels:
                    additionalProperties:
                      type: string
                    description: |-
                      Labels specifies additional labels to match when discovering workloads.
                      When combined with HelmRelease, narrows discovery to workloads matching these labels
                      in addition to the Helm release instance label.
                    type: object
                  namespace:
                    description: |-
                      Namespace specifies the namespace to look for the target workload.
                      Defaults to the CR's namespace if not specified.
                    type: string
                  pod:
                    description: Pod specifies a pod name to route requests to directly.
                    type: string
                  podOrdinal:
                    description: |-
                      PodOrdinal specifies the StatefulSet pod ordinal to route requests to.
                      Only used when targeting a StatefulSet and the operator is configured with --strategy=by-ordinal.
                    format: int32
                    minimum: 0
                    type: integer
                  statefulSet:
                    description: |-
                      StatefulSet specifies a StatefulSet name to route requests to.
                      When combined with HelmRelease, narrows discovery to only this StatefulSet within the release.
                    type: string
                type: object
            required:
            - resources
            type: object
          status:
            description: PetstoreBundleStatus defines the observed state of PetstoreBundle
            properties:
              aggregatedHealth:
                description: |-
                  AggregatedHealth provides Aggregate CRD-compatible health status.
                  This allows Bundle to be monitored using the same semantics as Aggregate CRD.
                properties:
                  computedValues:
                    description: ComputedValues contains the results of evaluating
                      CEL expressions from spec.derivedValues
                    items:
                      description: ComputedValue holds the result of evaluating a
                        CEL expression
                      properties:
                        error:
                          description: Error contains any error message if the expression
                            failed to evaluate
                          type: string
                        name:
                          description: Name is the name of the derived value
                          type: string
                        value:
                          description: Value is the computed result as a string (numbers,
                            booleans, strings are all stringified)
                          type: string
                      required:
                      - name
                      type: object
                    type: array
                  lastAggregationTime:
                    description: LastAggregationTime is when the health was last aggregated
                    format: date-time
                    type: string
                  resources:
                    description: Resources contains the status of each managed resource
                      in Aggregate-compatible format
                    items:
                      description: AggregatedResourceStatus represents the status
                        of a single aggregated resource
                      properties:
                        externalID:
                          description: ExternalID is the external API ID if available
                          type: string
                        kind:
                          description: Kind is the resource kind
                          type: string
                        lastSyncTime:
                          description: LastSyncTime is when the resource was last
                            synced
                          format: date-time
                          type: string
                        message:
                          description: Message is the status message from the resource
                          type: string
                        name:
                          description: Name is the resource name
                          type: string
                        namespace:
                          description: Namespace is the resource namespace
                          type: string
                        state:
                          description: State is the current state of the resource
                          type: string
                      required:
                      - kind
                      - name
                      - namespace
                      - state
                      type: object
                    type: array
                  state:
                    description: State represents the aggregated health state using
                      Aggregate CRD semantics
                    enum:
                    - Pending
                    - Healthy
                    - Degraded
                    - Unknown
                    type: string
                  summary:
                    description: Summary contains counts of resources by state (Aggregate-compatible
                      format)
                    properties:
                      failed:
                        description: Failed is the number of resources in Failed state
                        type: integer
                      pending:
                        description: Pending is the number of resources in Pending
                          or other states
                        type: integer
                      synced:
                        description: Synced is the number of resources in Synced state
                        type: integer
                      total:
                        description: Total is the total number of matched resources
                        type: integer
                    required:
                    - failed
                    - pending
                    - synced
                    - total
                    type: object
                type: object
              conditions:
                description: Conditions represent the latest observations of the bundle
                  state
                items:
                  description: Condition contains details for one aspect of the current
                    state of this API Resource.
                  properties:
                    lastTransitionTime:
                      description: |-
                        lastTransitionTime is the last time the condition transitioned from one status to another.
                        This should be when the underlying condition changed.  If that is not known, then using the time when the API field changed is acceptable.
                      format: date-time
                      type: string
                    message:
                      description: |-
                        message is a human readable message indicating details about the transition.
                        This may be an empty string.
                      maxLength: 32768
                      type: string
                    observedGeneration:
                      description: |-
                        observedGeneration represents the .metadata.generation that the condition was set based upon.
                        For instance, if .metadata.generation is currently 12, but the .status.conditions[x].observedGeneration is 9, the condition is out of date
                        with respect to the current state of the instance.
                      format: int64
                      minimum: 0
                      type: integer
                    reason:
                      description: |-
                        reason contains a programmatic identifier indicating the reason for the condition's last transition.
                        Producers of specific condition types may define expected values and meanings for this field,
                        and whether the values are considered a guaranteed API.
                        The value should be a CamelCase string.
                        This field may not be empty.
                      maxLength: 1024
                      minLength: 1
                      pattern: ^[A-Za-z]([A-Za-z0-9_,:]*[A-Za-z0-9_])?$
                      type: string
                    status:
                      description: status of the condition, one of True, False, Unknown.
                      enum:
                      - "True"
                      - "False"
                      - Unknown
                      type: string
                    type:
                      description: type of condition in CamelCase or in foo.example.com/CamelCase.
                      maxLength: 316
                      pattern: ^([a-z0-9]([-a-z0-9]*[a-z0-9])?(\.[a-z0-9]([-a-z0-9]*[a-z0-9])?)*/)?(([A-Za-z0-9][-A-Za-z0-9_.]*)?[A-Za-z0-9])$
                      type: string
                  required:
                  - lastTransitionTime
                  - message
                  - reason
                  - status
                  - type
                  type: object
                type: array
                x-kubernetes-list-map-keys:
                - type
                x-kubernetes-list-type: map
              message:
                description: Message describes the current state
                type: string
              observedGeneration:
                description: ObservedGeneration is the last observed spec generation
                format: int64
                type: integer
              operationState:
                description: OperationState tracks the current sync operation
                properties:
                  finishedAt:
                    description: FinishedAt is when the operation finished
                    format: date-time
                    type: string
                  message:
                    description: Message describes the current operation
                    type: string
                  phase:
                    description: Phase is the current operation phase
                    enum:
                    - Pending
                    - Running
                    - Succeeded
                    - Failed
                    type: string
                  retryCount:
                    description: RetryCount tracks retry attempts for failed operations
                    type: integer
                  startedAt:
                    description: StartedAt is when the operation started
                    format: date-time
                    type: string
                  wave:
                    description: Wave is the current sync wave being processed (if
                      wave ordering is enabled)
                    type: integer
                required:
                - phase
                type: object
              resources:
                description: Resources contains per-resource status
                items:
                  description: BundleResourceStatus represents the status of an embedded
                    resource
                  properties:
                    externalID:
                      description: ExternalID is the ID from the REST API (if available)
                      type: string
                    id:
                      description: ID is the resource identifier from spec
                      type: string
                    kind:
                      description: Kind is the resource kind
                      type: string
                    lastSyncTime:
                      description: LastSyncTime is when this resource was last synced
                      format: date-time
                      type: string
                    message:
                      description: Message contains status details or error information
                      type: string
                    name:
                      description: Name is the generated CR name in the cluster
                      type: string
                    ready:
                      description: Ready indicates if readyWhen conditions are met
                      type: boolean
                    skipped:
                      description: Skipped indicates if skipWhen conditions were met
                      type: boolean
                    state:
                      description: State is the current state of this resource
                      enum:
                      - Pending
                      - Creating
                      - Synced
                      - Failed
                      - Skipped
                      type: string
                  required:
                  - id
                  - kind
                  - name
                  - ready
                  - state
                  type: object
                type: array
              state:
                description: State is the aggregated bundle state
                enum:
                - Pending
                - Syncing
                - Synced
                - Failed
                - Paused
                type: string
              summary:
                description: Summary contains resource counts
                properties:
                  failed:
                    description: Failed is the number of resources in Failed state
                    type: integer
                  pending:
                    description: Pending is the number of resources in Pending state
                    type: integer
                  skipped:
                    description: Skipped is the number of resources that were skipped
                      (Bundle-specific)
                    type: integer
                  synced:
                    description: Synced is the number of resources in Synced state
                    type: integer
                  total:
                    description: Total is the total number of resources in the bundle
                    type: integer
                required:
                - failed
                - pending
                - skipped
                - synced
                - total
                type: object
            type: object
        type: object
    served: true
    storage: true
    subresources:
      status: {}
