/*
Copyright 2026 Generated by openapi-operator-gen v0.0.9-31-gec463de-dirty.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/

package controller

import (
	"context"
	"net/http"
	"net/http/httptest"
	"path/filepath"
	goruntime "runtime"
	"testing"

	. "github.com/onsi/ginkgo/v2"
	. "github.com/onsi/gomega"
	"k8s.io/client-go/kubernetes/scheme"
	"k8s.io/client-go/rest"
	"sigs.k8s.io/controller-runtime/pkg/client"
	"sigs.k8s.io/controller-runtime/pkg/envtest"
	logf "sigs.k8s.io/controller-runtime/pkg/log"
	"sigs.k8s.io/controller-runtime/pkg/log/zap"

	v1alpha1 "github.com/bluecontainer/petstore-operator/api/v1alpha1"
)

// These tests use Ginkgo (BDD-style Go testing framework). Refer to
// http://onsi.github.io/ginkgo/ to learn more about Ginkgo.

var (
	cfg        *rest.Config
	k8sClient  client.Client
	testEnv    *envtest.Environment
	ctx        context.Context
	cancel     context.CancelFunc
	mockServer *httptest.Server
)

func TestControllers(t *testing.T) {
	RegisterFailHandler(Fail)
	RunSpecs(t, "Controller Integration Suite")
}

var _ = BeforeSuite(func() {
	logf.SetLogger(zap.New(zap.WriteTo(GinkgoWriter), zap.UseDevMode(true)))

	ctx, cancel = context.WithCancel(context.Background())

	By("bootstrapping test environment")
	testEnv = &envtest.Environment{
		CRDDirectoryPaths:     []string{filepath.Join("..", "..", "config", "crd", "bases")},
		ErrorIfCRDPathMissing: true,

		// The BinaryAssetsDirectory is only required if you want to run the tests directly
		// without calling the makefile target test. If not informed it will look for the
		// temporary folder created by the Makefile target.
		BinaryAssetsDirectory: filepath.Join("..", "..", "bin", "k8s",
			"1.29.0-"+goruntime.GOOS+"-"+goruntime.GOARCH),
	}

	var err error
	// cfg is defined in this file globally.
	cfg, err = testEnv.Start()
	if err != nil {
		// Skip gracefully if envtest binaries aren't installed
		// Run 'make envtest' to download them, then 'make test-integration'
		Skip("envtest binaries not found - run 'make envtest' to install them, then 'make test-integration'")
	}
	Expect(cfg).NotTo(BeNil())

	err = v1alpha1.AddToScheme(scheme.Scheme)
	Expect(err).NotTo(HaveOccurred())

	// +kubebuilder:scaffold:scheme

	k8sClient, err = client.New(cfg, client.Options{Scheme: scheme.Scheme})
	Expect(err).NotTo(HaveOccurred())
	Expect(k8sClient).NotTo(BeNil())

	// Create a mock HTTP server for REST API calls
	mockServer = createMockServer()
})

var _ = AfterSuite(func() {
	if cancel != nil {
		cancel()
	}
	if mockServer != nil {
		mockServer.Close()
	}
	if testEnv != nil && cfg != nil {
		By("tearing down the test environment")
		err := testEnv.Stop()
		Expect(err).NotTo(HaveOccurred())
	}
})

// createMockServer creates a mock HTTP server that simulates REST API responses
func createMockServer() *httptest.Server {
	return httptest.NewServer(http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
		w.Header().Set("Content-Type", "application/json")

		// Default successful response
		switch r.Method {
		case http.MethodGet:
			w.WriteHeader(http.StatusOK)
			w.Write([]byte(`{"id": 123, "name": "test-resource"}`))
		case http.MethodPost:
			w.WriteHeader(http.StatusCreated)
			w.Write([]byte(`{"id": 123, "name": "test-resource"}`))
		case http.MethodPut:
			w.WriteHeader(http.StatusOK)
			w.Write([]byte(`{"id": 123, "name": "updated-resource"}`))
		case http.MethodDelete:
			w.WriteHeader(http.StatusNoContent)
		default:
			w.WriteHeader(http.StatusMethodNotAllowed)
		}
	}))
}

// GetMockServerURL returns the mock server URL for use in tests
func GetMockServerURL() string {
	return mockServer.URL
}

// GetMockServerClient returns the HTTP client configured for the mock server
func GetMockServerClient() *http.Client {
	return mockServer.Client()
}

// GetK8sClient returns the Kubernetes client for use in tests
func GetK8sClient() client.Client {
	return k8sClient
}

// GetConfig returns the REST config for use in tests
func GetConfig() *rest.Config {
	return cfg
}

// GetContext returns the test context
func GetContext() context.Context {
	return ctx
}
